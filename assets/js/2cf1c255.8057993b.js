"use strict";(self.webpackChunkzio_site=self.webpackChunkzio_site||[]).push([[43608],{42519:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>r,default:()=>h,frontMatter:()=>s,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"zio-metrics-connectors/metrics/datadog-client","title":"Datadog Client","description":"In a normal DataDog setup we will find a DataDog agent with an open UDP port where applications send their","source":"@site/docs/zio-metrics-connectors/metrics/datadog-client.md","sourceDirName":"zio-metrics-connectors/metrics","slug":"/zio-metrics-connectors/metrics/datadog-client","permalink":"/zio-metrics-connectors/metrics/datadog-client","draft":false,"unlisted":false,"editUrl":"https://github.com/zio/zio/edit/series/2.x/docs/zio-metrics-connectors/metrics/datadog-client.md","tags":[],"version":"current","frontMatter":{"id":"datadog-client","title":"Datadog Client"},"sidebar":"ecosystem-sidebar","previous":{"title":"StatsD Client","permalink":"/zio-metrics-connectors/metrics/statsd-client"},"next":{"title":"Prometheus Client","permalink":"/zio-metrics-connectors/metrics/prometheus-client"}}');var i=n(74848),o=n(28453);const s={id:"datadog-client",title:"Datadog Client"},r=void 0,d={},c=[{value:"ZIO metrics in DogStatsD",id:"zio-metrics-in-dogstatsd",level:2},{value:"Counter",id:"counter",level:3},{value:"Gauge",id:"gauge",level:3},{value:"Histogram",id:"histogram",level:3},{value:"Summary",id:"summary",level:3},{value:"Sets",id:"sets",level:3},{value:"The ZIO metrics DataDog example",id:"the-zio-metrics-datadog-example",level:2},{value:"A simple StatsD / Datadog setup",id:"a-simple-statsd--datadog-setup",level:2},{value:"Get and run the docker based Datadog collector",id:"get-and-run-the-docker-based-datadog-collector",level:3},{value:"Run the Datadog example",id:"run-the-datadog-example",level:3},{value:"Visualize the metrics",id:"visualize-the-metrics",level:3},{value:"Datadog dashboard",id:"datadog-dashboard",level:3}];function l(e){const t={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(t.p,{children:["In a normal DataDog setup we will find a DataDog agent with an open UDP port where applications send their\nmetrics to. The format of the metrics is defined by the ",(0,i.jsx)(t.a,{href:"https://docs.datadoghq.com/developers/dogstatsd/datagram_shell/?tab=metrics",children:"DogStatsD protocol"}),"."]}),"\n",(0,i.jsx)(t.p,{children:"With the DataDog client zio metrics creates the relevant DogStatsD datagrams and sends them via UDP."}),"\n",(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsx)(t.p,{children:"The instrumented code is exactly the same as for the Prometheus instrumentation. The only difference is that\nanother client is provided when the App is configured."}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"zio-metrics-in-dogstatsd",children:"ZIO metrics in DogStatsD"}),"\n",(0,i.jsx)(t.p,{children:"DogStatsD normally has its own definition how histograms and summaries are configured. In the default setup this\nis defined in the config file of the statsd agent. Furthermore, a StatsD Histogram is more or less the\nequivalent of a Prometheus summary."}),"\n",(0,i.jsx)(t.p,{children:"However, whenever the desired quantiles need to change, the config must be adjusted and the agent restarted."}),"\n",(0,i.jsx)(t.p,{children:"Therefore, the ZIO Metrics Datadog client maps the more complex metrics to a set of related gauges. This allows us to achieve\nthe same visualization without the need to adjust any of the agents config files."}),"\n",(0,i.jsx)(t.h3,{id:"counter",children:"Counter"}),"\n",(0,i.jsx)(t.p,{children:"Counters are reported periodically within a configurable time interval."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"countAll:1|c\n"})}),"\n",(0,i.jsx)(t.h3,{id:"gauge",children:"Gauge"}),"\n",(0,i.jsx)(t.p,{children:"Gauges are reported periodically within a configurable time interval."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"adjustGauge:32.2787317766752|g\n"})}),"\n",(0,i.jsx)(t.h3,{id:"histogram",children:"Histogram"}),"\n",(0,i.jsx)(t.p,{children:"A histogram is reported as a datadog distribution whenever a new value is submitted. The bucket configuration is\nignored in this case, as DataDog expects raw values to be recorded."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"myHistogram:3|d\n"})}),"\n",(0,i.jsx)(t.h3,{id:"summary",children:"Summary"}),"\n",(0,i.jsxs)(t.p,{children:["A summary is periodically reported as a set of related gauges, within a configurable time interval. Each quantile will\nbe reported within its own gauge. The additional labels are ",(0,i.jsx)(t.code,{children:"quantile"})," to address the quantile and ",(0,i.jsx)(t.code,{children:"error"})," to display\nthe configured error margin."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"mySummary:123|g|#quantile:0.1,error:0.03\nmySummary:254|g|#quantile:0.5,error:0.03\nmySummary:441|g|#quantile:0.9,error:0.03\n"})}),"\n",(0,i.jsx)(t.h3,{id:"sets",children:"Sets"}),"\n",(0,i.jsx)(t.p,{children:"Sets are also reported as sets of related gauges. An additional label is used to differentiate the distinct\nvalues in the set. The name of the label is as configured in the aspect used to capture the set."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"mySet:6|g|#token:myKey-18\nmySet:1|g|#token:myKey-19\nmySet:2|g|#token:myKey-13\nmySet:3|g|#token:myKey-14\nmySet:1|g|#token:myKey-16\nmySet:3|g|#token:myKey-10\nmySet:2|g|#token:myKey-11\nmySet:1|g|#token:myKey-12\n"})}),"\n",(0,i.jsx)(t.h2,{id:"the-zio-metrics-datadog-example",children:"The ZIO metrics DataDog example"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-scala",children:"import zio.Console._\nimport zio._\nimport zio.metrics.connectors._\n\nval instrumentedSample = new InstrumentedSample() {}\n"})}),"\n",(0,i.jsx)(t.p,{children:"For DataDog we do need to spin up our own server. Rather we need to provide a client that can send datagrams\nto a specified UDP destination."}),"\n",(0,i.jsx)(t.p,{children:"Again we need an effect that runs our instrumented code until the user presses any key:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-scala",children:'val execute =\n  for {\n   fiber <- instrumentedSample.program.fork\n    _ <- putStrLn("Press Any Key") *> getStrLn.orDie \n    _ <- fiber.interrupt\n  } yield ExitCode.success\n'})}),"\n",(0,i.jsxs)(t.p,{children:["Now, we can override the ",(0,i.jsx)(t.code,{children:"run"})," method of our ZIO ",(0,i.jsx)(t.code,{children:"App"})," and simply provide a ",(0,i.jsx)(t.code,{children:"datadog.datadogLayer"}),"."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-scala",children:'  override def run: ZIO[ZIOAppArgs with Scope, Any, Any] =\n    execute\n      .provide(\n        ZLayer.succeed(datadog.DatadogConfig("localhost", 8125)),\n        ZLayer.succeed(MetricsConfig(100.millis)),\n        datadog.datadogLayer,\n      )\n      .orDie\n'})}),"\n",(0,i.jsx)(t.h2,{id:"a-simple-statsd--datadog-setup",children:"A simple StatsD / Datadog setup"}),"\n",(0,i.jsxs)(t.p,{children:["The following steps describe how to set up a ZIO application reporting to ",(0,i.jsx)(t.a,{href:"https://www.datadoghq.com/",children:"Datadog"})," using a free Datadog account\nwith limited functionality. The local setup is Windows 10 with WSL and Docker installed running Ubuntu 18.04 within WSL."]}),"\n",(0,i.jsx)(t.p,{children:"In principle the setup is as follows:"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["The ZIO application sends datagrams to ",(0,i.jsx)(t.code,{children:"localhost:8125"})," via UDP, so we need a component picking up those datagrams."]}),"\n",(0,i.jsx)(t.li,{children:"Run a Datadog Collector within a docker image exposing a Unix socket for datagrams."}),"\n",(0,i.jsxs)(t.li,{children:["Run ",(0,i.jsx)(t.code,{children:"socat"})," to listen on the UDP socket 8125 and forward incoming traffic to the Unix socket."]}),"\n",(0,i.jsx)(t.li,{children:"Configure a dashboard in Datadog to visualize the metrics."}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"get-and-run-the-docker-based-datadog-collector",children:"Get and run the docker based Datadog collector"}),"\n",(0,i.jsxs)(t.p,{children:["Upon registration with datadoghq.com you will get an API key which is required to configure the agents collecting data. If you are planning\nto experiment with different agents, take a note of your API key for further reference. In the steps below the API key will be referred to\nas ",(0,i.jsx)(t.code,{children:"$APIKEY"})]}),"\n",(0,i.jsx)(t.p,{children:"For our example we have chosen to use the docker based collector and use a unix socket to report our datagrams to that agent."}),"\n",(0,i.jsx)(t.p,{children:"You can start the agent from the command line with"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"docker run --name dd-agent -e DD_API_KEY=$APIKEY -e DD_SITE=datadoghq.eu \\\n  -e DD_DOGSTATSD_SOCKET=/var/run/datadog/datadog.sock \\\n  -v /var/run/datadog:/var/run/datadog \\\n  -v /var/run/docker.sock:/var/run/docker.sock:ro \\\n  datadog/agent\n"})}),"\n",(0,i.jsxs)(t.p,{children:["As you can see, we require that the directory ",(0,i.jsx)(t.code,{children:"/var/run/datadog"})," exists so that we can use it as a volume within the agent's docker container. The environment variable ",(0,i.jsx)(t.code,{children:"DD_DOGSTATSD_SOCKET"})," tells the agent to use a unix socket to listen for datagrams. The socket file must reside within the mounted volume."]}),"\n",(0,i.jsx)(t.p,{children:"This will start the datadog collector within docker and we have a unix socket to report our datagrams to."}),"\n",(0,i.jsxs)(t.p,{children:["The next step is to create a UDP socket where our application can report its datagrams to. For our example we have chosen ",(0,i.jsx)(t.code,{children:"socat"})," to forward\nUDP traffic to our unix socket:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"sudo socat -s -u udp-recv:8125 unix-sendto:/var/run/datadog/datadog.sock\n"})}),"\n",(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsxs)(t.p,{children:["You could add the ",(0,i.jsx)(t.code,{children:"-v"})," parameter to the socat call to run socat in verbose mode. That would print\nall traffic being forwarded to the console as well. This is useful to determine whether\ndatagrams are actually sent."]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"run-the-datadog-example",children:"Run the Datadog example"}),"\n",(0,i.jsx)(t.p,{children:"Now, the Datadog example can be started from within the project checkout directory with"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"sbt sampleApp/run\n"})}),"\n",(0,i.jsx)(t.h3,{id:"visualize-the-metrics",children:"Visualize the metrics"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsx)(t.li,{children:"Log in to your datadog account"}),"\n",(0,i.jsx)(t.li,{children:"From the menu on left hand side select `Dashboards/New Dashboard'"}),"\n",(0,i.jsx)(t.li,{children:"In the upper right corner, click on the dashboard settings and select 'Import Dashboard JSON'"}),"\n",(0,i.jsxs)(t.li,{children:["From the filesystem, select ",(0,i.jsx)(t.code,{children:"$DIR/examples/statsd/ZIOMetrics.json"})]}),"\n",(0,i.jsx)(t.li,{children:"Confirm to override the dashboard configuration"}),"\n",(0,i.jsx)(t.li,{children:"Save the just imported dashboard"}),"\n",(0,i.jsxs)(t.li,{children:["From the dashboard list select ",(0,i.jsx)(t.em,{children:"ZIO metrics"})]}),"\n",(0,i.jsx)(t.li,{children:"The Datadog dashboard is displayed"}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"datadog-dashboard",children:"Datadog dashboard"}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.img,{alt:"A simple Datadog Dashboard",src:n(27418).A+"",width:"1892",height:"1144"})})]})}function h(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},27418:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/Datadog-4688e7cee89ae0c3593cec628b18ab6f.png"},28453:(e,t,n)=>{n.d(t,{R:()=>s,x:()=>r});var a=n(96540);const i={},o=a.createContext(i);function s(e){const t=a.useContext(o);return a.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),a.createElement(o.Provider,{value:t},e.children)}}}]);