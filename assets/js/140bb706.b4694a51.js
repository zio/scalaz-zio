"use strict";(self.webpackChunkzio_site=self.webpackChunkzio_site||[]).push([[20037],{51387:(e,i,n)=>{n.r(i),n.d(i,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"zio-mock/index","title":"Introduction to ZIO Mock","description":"Development CI Badge Sonatype Releases Sonatype Snapshots javadoc ZIO Mock","source":"@site/docs/zio-mock/index.md","sourceDirName":"zio-mock","slug":"/zio-mock/","permalink":"/zio-mock/","draft":false,"unlisted":false,"editUrl":"https://github.com/zio/zio/edit/series/2.x/docs/zio-mock/index.md","tags":[],"version":"current","frontMatter":{"id":"index","title":"Introduction to ZIO Mock","sidebar_label":"ZIO Mock"},"sidebar":"ecosystem-sidebar","previous":{"title":"Instrumentation Examples","permalink":"/zio-metrics-connectors/metrics/instrumentation-examples"},"next":{"title":"Mock","permalink":"/zio-mock/mock"}}');var s=n(74848),o=n(28453);const r={id:"index",title:"Introduction to ZIO Mock",sidebar_label:"ZIO Mock"},c=void 0,a={},l=[{value:"Installation",id:"installation",level:2},{value:"The Problem",id:"the-problem",level:2},{value:"The Solution",id:"the-solution",level:2},{value:"Mocking Collaborators",id:"mocking-collaborators",level:2},{value:"Testing the Service",id:"testing-the-service",level:2}];function d(e){const i={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(i.p,{children:[(0,s.jsx)(i.a,{href:"https://github.com/zio/zio/wiki/Project-Stages",children:(0,s.jsx)(i.img,{src:"https://img.shields.io/badge/Project%20Stage-Development-green.svg",alt:"Development"})})," ",(0,s.jsx)(i.img,{src:"https://github.com/zio/zio-mock/workflows/CI/badge.svg",alt:"CI Badge"})," ",(0,s.jsx)(i.a,{href:"https://oss.sonatype.org/content/repositories/releases/dev/zio/zio-mock_2.13/",children:(0,s.jsx)(i.img,{src:"https://img.shields.io/nexus/r/https/oss.sonatype.org/dev.zio/zio-mock_2.13.svg?label=Sonatype%20Release",alt:"Sonatype Releases"})})," ",(0,s.jsx)(i.a,{href:"https://oss.sonatype.org/content/repositories/snapshots/dev/zio/zio-mock_2.13/",children:(0,s.jsx)(i.img,{src:"https://img.shields.io/nexus/s/https/oss.sonatype.org/dev.zio/zio-mock_2.13.svg?label=Sonatype%20Snapshot",alt:"Sonatype Snapshots"})})," ",(0,s.jsx)(i.a,{href:"https://javadoc.io/doc/dev.zio/zio-mock-docs_2.13",children:(0,s.jsx)(i.img,{src:"https://javadoc.io/badge2/dev.zio/zio-mock-docs_2.13/javadoc.svg",alt:"javadoc"})})," ",(0,s.jsx)(i.a,{href:"https://github.com/zio/zio-mock",children:(0,s.jsx)(i.img,{src:"https://img.shields.io/github/stars/zio/zio-mock?style=social",alt:"ZIO Mock"})})]}),"\n",(0,s.jsx)(i.h2,{id:"installation",children:"Installation"}),"\n",(0,s.jsxs)(i.p,{children:["In order to use this library, we need to add the following line in our ",(0,s.jsx)(i.code,{children:"build.sbt"})," file:"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-scala",children:'libraryDependencies += "dev.zio" %% "zio-mock" % "1.0.0-RC12"\n'})}),"\n",(0,s.jsx)(i.h2,{id:"the-problem",children:"The Problem"}),"\n",(0,s.jsx)(i.p,{children:"Whenever possible, we should strive to make our functions pure, which makes testing such function easy. So we just need to assert on the return value. However, in larger applications there is a need for intermediate layers that delegate the work to specialized services."}),"\n",(0,s.jsxs)(i.p,{children:["For example, in an HTTP server, the first layers of indirection are so-called ",(0,s.jsx)(i.em,{children:"routes"}),", whose job is to match the request and delegate the processing to downstream layers. Below this layer, there is often a second layer of indirection, so-called ",(0,s.jsx)(i.em,{children:"controllers"}),", which comprises several business logic units grouped by their domain. In a RESTful API, that would be all operations on a certain model. The ",(0,s.jsx)(i.em,{children:"controller"})," to perform its job might call on further specialized services for communicating with the database, sending email, logging, etc."]}),"\n",(0,s.jsxs)(i.p,{children:["If the job of the ",(0,s.jsx)(i.em,{children:"capability"})," is to call on another ",(0,s.jsx)(i.em,{children:"capability"}),", how should we test it?"]}),"\n",(0,s.jsxs)(i.p,{children:["Let's say we have a ",(0,s.jsx)(i.code,{children:"Userservice"})," defined as follows:"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-scala",children:"import zio._\n\ntrait UserService {\n  def register(username: String, age: Int, email: String): IO[String, Unit]\n}\n\nobject UserService {\n  def register(username: String, age: Int, email: String): ZIO[UserService, String, Unit] =\n    ZIO.serviceWithZIO(_.register(username, age, email))\n}\n"})}),"\n",(0,s.jsxs)(i.p,{children:["The live implementation of the ",(0,s.jsx)(i.code,{children:"UserService"})," has two collaborators, ",(0,s.jsx)(i.code,{children:"EmailService"})," and ",(0,s.jsx)(i.code,{children:"UserRepository"}),":"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-scala",children:"trait EmailService {\n  def send(to: String, body: String): IO[String, Unit]\n}\n\ncase class User(username: String, age: Int, email: String)\n\ntrait UserRepository {\n  def save(user: User): IO[String, Unit]\n}\n"})}),"\n",(0,s.jsxs)(i.p,{children:["Following is how the live version of ",(0,s.jsx)(i.code,{children:"UserService"})," is implemented:"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-scala",children:'case class UserServiceLive(emailService: EmailService, userRepository: UserRepository) extends UserService {\n  override def register(username: String, age: Int, email: String): IO[String, Unit] =\n    if (age < 18) {\n      emailService.send(email, "You are not eligible to register!")\n    } else if (username == "admin") {\n      ZIO.fail("The admin user is already registered!")\n    } else {\n      for {\n        _ <- userRepository.save(User(username, age, email))\n        _ <- emailService.send(email, "Congratulation, you are registered!")\n      } yield ()\n    }\n}\n\nobject UserServiceLive {\n  val layer: URLayer[EmailService with UserRepository, UserService] =\n    ZLayer.fromFunction(UserServiceLive.apply _)\n}\n'})}),"\n",(0,s.jsxs)(i.p,{children:["A pure function is such a function which operates only on its inputs and produces only its output. Command-like methods, by definition are impure, as their job is to change state of the collaborating object (performing a ",(0,s.jsx)(i.em,{children:"side effect"}),"). For example:"]}),"\n",(0,s.jsxs)(i.p,{children:["The signature of ",(0,s.jsx)(i.code,{children:"register"})," method ",(0,s.jsx)(i.code,{children:"(String, Int, String) => IO[String, Unit]"})," hints us we're dealing with a command. It returns ",(0,s.jsx)(i.code,{children:"Unit"})," (well, wrapped in the ",(0,s.jsx)(i.code,{children:"IO"}),", but it does not matter here). We can't do anything useful with ",(0,s.jsx)(i.code,{children:"Unit"}),", and it does not contain any information. It is the equivalent of returning nothing."]}),"\n",(0,s.jsxs)(i.p,{children:["It is also an unreliable return type, as when Scala expects the return type to be ",(0,s.jsx)(i.code,{children:"Unit"})," it will discard whatever value it had (for details see [Section 6.26.1][link-sls-6.26.1] of the Scala Language Specification), which may shadow the fact that the final value produced (and discarded) was not the one we expected."]}),"\n",(0,s.jsxs)(i.p,{children:["Inside the ",(0,s.jsx)(i.code,{children:"IO"})," there may be a description of any side effects. It may open a file, print to the console, or connect to databases. ",(0,s.jsx)(i.strong,{children:'So the problem is "How is it possible to test a service along with its collaborators"?'})]}),"\n",(0,s.jsxs)(i.p,{children:["In this example, the ",(0,s.jsx)(i.code,{children:"register"})," method has a service call to its collaborators, ",(0,s.jsx)(i.code,{children:"UserRepository"})," and ",(0,s.jsx)(i.code,{children:"EmailService"}),".  So, how can we test the live version of ",(0,s.jsx)(i.code,{children:"UserService.register"})," while it has some side effects in communicating with its collaborators?"]}),"\n",(0,s.jsx)(i.p,{children:"Mockists would probably claim that testing how collaborators are called during the test process allows us to test the UserService. Let's move on to the next section and see the mockists' solution in greater detail."}),"\n",(0,s.jsx)(i.h2,{id:"the-solution",children:"The Solution"}),"\n",(0,s.jsxs)(i.p,{children:["In this sort of situations we need mock implementations of our ",(0,s.jsx)(i.em,{children:"collaborator service"}),". As ",(0,s.jsx)(i.em,{children:"Martin Fowler"})," puts it in his excellent article [Mocks Aren't Stubs][link-test-doubles]:"]}),"\n",(0,s.jsxs)(i.blockquote,{children:["\n",(0,s.jsxs)(i.p,{children:[(0,s.jsx)(i.strong,{children:"Mocks"})," are (...) objects pre-programmed with expectations which form a specification of the calls they are expected to receive."]}),"\n"]}),"\n",(0,s.jsxs)(i.p,{children:["So to test the ",(0,s.jsx)(i.code,{children:"register"})," function, we can mock the behavior of its two collaborators. So instead of using production objects, we use pre-programmed mock versions of these two collaborators with some expectations. In this way, in each test case, we expect these collaborators will be called with expected inputs."]}),"\n",(0,s.jsx)(i.p,{children:"In this example, we can define these three test cases:"}),"\n",(0,s.jsxs)(i.ol,{children:["\n",(0,s.jsxs)(i.li,{children:["If we register a user with an age of less than 18, we expect that the ",(0,s.jsx)(i.code,{children:"save"})," method of ",(0,s.jsx)(i.code,{children:"UserRepository"})," shouldn't be called. Additionally, we expect that the ",(0,s.jsx)(i.code,{children:"send"})," method of ",(0,s.jsx)(i.code,{children:"EmailService"}),' will be called with the following content: "You are not eligible to register."']}),"\n",(0,s.jsxs)(i.li,{children:['If we register a user with a username of "admin", we expect that both ',(0,s.jsx)(i.code,{children:"UserRepository"})," and ",(0,s.jsx)(i.code,{children:"EmailService"})," should not be called. Instead, we expect that the ",(0,s.jsx)(i.code,{children:"register"}),' call will be failed with a proper failure value: "The admin user is already registered!"']}),"\n",(0,s.jsxs)(i.li,{children:["Otherwise, we expect that the ",(0,s.jsx)(i.code,{children:"save"})," method of ",(0,s.jsx)(i.code,{children:"UserRepository"})," will be called with the corresponding ",(0,s.jsx)(i.code,{children:"User"})," object, and the ",(0,s.jsx)(i.code,{children:"send"})," method of ",(0,s.jsx)(i.code,{children:"EmailService"}),' will be called with this content: "Congratulation, you are registered!".']}),"\n"]}),"\n",(0,s.jsxs)(i.p,{children:["ZIO Test provides a framework for mocking our modules. In the next section, we are going to test ",(0,s.jsx)(i.code,{children:"UserService"})," by mocking its collaborators."]}),"\n",(0,s.jsx)(i.h2,{id:"mocking-collaborators",children:"Mocking Collaborators"}),"\n",(0,s.jsxs)(i.p,{children:["In the previous section, we learned we can test the ",(0,s.jsx)(i.code,{children:"UserService"})," by mocking its collaborators. Let's see how we can mock the ",(0,s.jsx)(i.code,{children:"EmailService"})," and also the ",(0,s.jsx)(i.code,{children:"UserRepository"}),"."]}),"\n",(0,s.jsxs)(i.p,{children:["We should create a mock object by extending ",(0,s.jsx)(i.code,{children:"Mock[EmailService]"})," (",(0,s.jsx)(i.code,{children:"zio.mock.Mock"}),"). Then we need to define the following objects:"]}),"\n",(0,s.jsxs)(i.ol,{children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Capability tags"})," \u2014 They are value objects which extend one of the ",(0,s.jsx)(i.code,{children:"Capability[R, I, E, A]"})," data types, such as ",(0,s.jsx)(i.code,{children:"Effect"}),", ",(0,s.jsx)(i.code,{children:"Method"}),", ",(0,s.jsx)(i.code,{children:"Sink"}),", or ",(0,s.jsx)(i.code,{children:"Stream"}),". For each of the service capabilities, we need to create an object extending one of these data types. They encode the type of ",(0,s.jsx)(i.em,{children:"environments"}),", ",(0,s.jsx)(i.em,{children:"arguments"})," (inputs), the ",(0,s.jsx)(i.em,{children:"error channel"}),", and also the ",(0,s.jsx)(i.em,{children:"success channel"})," of each capability of the service."]}),"\n"]}),"\n",(0,s.jsxs)(i.p,{children:["For example, to encode the ",(0,s.jsx)(i.code,{children:"send"})," capability of ",(0,s.jsx)(i.code,{children:"EmailService"})," we need to extend the ",(0,s.jsx)(i.code,{children:"Effect"})," capability as bellow:"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-scala",children:"object Send extends Effect[(String, String), String, Unit]\n"})}),"\n",(0,s.jsxs)(i.ol,{start:"2",children:["\n",(0,s.jsxs)(i.li,{children:[(0,s.jsx)(i.strong,{children:"Compose layer"})," \u2014 In this step, we need to provide a layer in which used to construct the mocked object. In order to do that, we should obtain the ",(0,s.jsx)(i.code,{children:"Proxy"})," data type from the environment and then implement the service interface (i.e. ",(0,s.jsx)(i.code,{children:"EmailService"}),") by wrapping all capability tags with proxy."]}),"\n"]}),"\n",(0,s.jsxs)(i.p,{children:["Let's see how we can mock the ",(0,s.jsx)(i.code,{children:"EmailService"}),":"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-scala",children:"// Test Sources\nimport zio._\nimport zio.mock._\n\nobject MockEmailService extends Mock[EmailService] {\n  object Send extends Effect[(String, String), String, Unit]\n\n  val compose: URLayer[Proxy, EmailService] =\n    ZLayer {\n      for {\n         proxy <- ZIO.service[Proxy]\n      } yield new EmailService {\n        override def send(to: String, body: String): IO[String, Unit] =\n          proxy(Send, to, body)\n      }\n    }\n}\n"})}),"\n",(0,s.jsxs)(i.p,{children:["And, here is the mock version of the ",(0,s.jsx)(i.code,{children:"UserRepository"}),":"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-scala",children:"object MockUserRepository extends Mock[UserRepository] {\n  object Save extends Effect[User, String, Unit]\n\n  val compose: URLayer[Proxy, UserRepository] =\n    ZLayer {\n      for {\n        proxy <- ZIO.service[Proxy]\n      } yield new UserRepository {\n        override def save(user: User): IO[String, Unit] =\n          proxy(Save, user)\n      }\n    }\n}\n"})}),"\n",(0,s.jsx)(i.h2,{id:"testing-the-service",children:"Testing the Service"}),"\n",(0,s.jsxs)(i.p,{children:["After writing the mock version of collaborators, now we can use their ",(0,s.jsx)(i.em,{children:"capability tags"})," to convert them to the ",(0,s.jsx)(i.code,{children:"Expectation"}),", and finally create the mock layer of the service."]}),"\n",(0,s.jsxs)(i.p,{children:["For example, we can create an expectation from the ",(0,s.jsx)(i.code,{children:"Send"})," capability tag of the ",(0,s.jsx)(i.code,{children:"MockEmailService"}),":"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-scala",children:'import zio.test._\n\nval sendEmailExpectation: Expectation[EmailService] =\n  MockEmailService.Send(\n    assertion = Assertion.equalTo(("john@doe", "You are not eligible to register!")),\n    result = Expectation.unit\n  )\n'})}),"\n",(0,s.jsxs)(i.p,{children:["The ",(0,s.jsx)(i.code,{children:"sendEmailExpectation"})," is an expectation, which requires a call to ",(0,s.jsx)(i.code,{children:"send"})," method with ",(0,s.jsx)(i.code,{children:'("john@doe", "You are not eligible to register!")'})," arguments. If this service will be called, the returned value would be ",(0,s.jsx)(i.code,{children:"unit"}),"."]}),"\n",(0,s.jsxs)(i.p,{children:["There is an extension method called ",(0,s.jsx)(i.code,{children:"Expectation#toLayer"})," which implicitly converts an expectation to the ",(0,s.jsx)(i.code,{children:"ZLayer"})," environment:"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-scala",children:'import zio.test._\n\nval mockEmailService: ULayer[EmailService] =\n  MockEmailService.Send(\n    assertion = Assertion.equalTo(("john@doe", "You are not eligible to register!")),\n    result = Expectation.unit\n  ).toLayer\n'})}),"\n",(0,s.jsxs)(i.p,{children:["So we do not require to convert them to ",(0,s.jsx)(i.code,{children:"ZLayer"})," explicitly. It will convert them whenever required."]}),"\n",(0,s.jsxs)(i.ol,{children:["\n",(0,s.jsxs)(i.li,{children:["Now let's test the first scenario discussed in the ",(0,s.jsx)(i.a,{href:"#the-solution",children:"solution"})," section:"]}),"\n"]}),"\n",(0,s.jsxs)(i.blockquote,{children:["\n",(0,s.jsxs)(i.p,{children:["If we register a user with an age of less than 18, we expect that the ",(0,s.jsx)(i.code,{children:"save"})," method of ",(0,s.jsx)(i.code,{children:"UserRepository"})," shouldn't be called. Additionally, we expect that the ",(0,s.jsx)(i.code,{children:"send"})," method of ",(0,s.jsx)(i.code,{children:"EmailService"}),' will be called with the following content: "You are not eligible to register."']}),"\n"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-scala",children:'\ntest("non-adult registration") {\n  val sut              = UserService.register("john", 15, "john@doe")\n  val liveUserService  = UserServiceLive.layer\n  val mockUserRepo     = MockUserRepository.empty\n  val mockEmailService = MockEmailService.Send(\n    assertion = Assertion.equalTo(("john@doe", "You are not eligible to register!")),\n    result = Expectation.unit\n  )\n\n  for {\n    _ <- sut.provide(liveUserService, mockUserRepo, mockEmailService)\n  } yield assertTrue(true)\n}\n'})}),"\n",(0,s.jsxs)(i.p,{children:["We used ",(0,s.jsx)(i.code,{children:"MockUserRepository.empty"})," since we expect no call to the ",(0,s.jsx)(i.code,{children:"UserRepository"})," service."]}),"\n",(0,s.jsxs)(i.ol,{start:"2",children:["\n",(0,s.jsx)(i.li,{children:"The second scenario is:"}),"\n"]}),"\n",(0,s.jsxs)(i.blockquote,{children:["\n",(0,s.jsxs)(i.p,{children:['If we register a user with a username of "admin", we expect that both ',(0,s.jsx)(i.code,{children:"UserRepository"})," and ",(0,s.jsx)(i.code,{children:"EmailService"})," should not be called. Instead, we expect that the ",(0,s.jsx)(i.code,{children:"register"}),' call will be failed with a proper failure value: "The admin user is already registered!"']}),"\n"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-scala",children:'\ntest("user cannot register pre-defined admin user") {\n  val sut = UserService.register("admin", 30, "admin@doe")\n\n  for {\n    result <- sut.provide(\n      UserServiceLive.layer,\n      MockEmailService.empty,\n      MockUserRepository.empty\n    ).exit\n  } yield assertTrue(\n    result match {\n      case Exit.Failure(cause)\n        if cause.contains(\n          Cause.fail("The admin user is already registered!")\n        ) => true\n      case _ => false\n    }\n  )\n}\n'})}),"\n",(0,s.jsxs)(i.ol,{start:"3",children:["\n",(0,s.jsxs)(i.li,{children:["Finally, we have to check the ",(0,s.jsx)(i.em,{children:"happy path"})," scenario:"]}),"\n"]}),"\n",(0,s.jsxs)(i.blockquote,{children:["\n",(0,s.jsxs)(i.p,{children:["We expect that the ",(0,s.jsx)(i.code,{children:"save"})," method of ",(0,s.jsx)(i.code,{children:"UserRepository"})," will be called with the corresponding ",(0,s.jsx)(i.code,{children:"User"})," object, and the ",(0,s.jsx)(i.code,{children:"send"})," method of ",(0,s.jsx)(i.code,{children:"EmailService"}),' will be called with this content: "Congratulation, you are registered!".']}),"\n"]}),"\n",(0,s.jsx)(i.pre,{children:(0,s.jsx)(i.code,{className:"language-scala",children:'\ntest("a valid user can register to the user service") {\n  val sut              = UserService.register("jane", 25, "jane@doe")\n  val liveUserService  = UserServiceLive.layer\n  val mockUserRepo     = MockUserRepository.Save(\n    Assertion.equalTo(User("jane", 25, "jane@doe")),\n    Expectation.unit\n  )\n  val mockEmailService = MockEmailService.Send(\n    assertion = Assertion.equalTo(("jane@doe", "Congratulation, you are registered!")),\n    result = Expectation.unit\n  )\n\n  for {\n    _ <- sut.provide(liveUserService, mockUserRepo, mockEmailService)\n  } yield assertTrue(true)\n}\n'})})]})}function h(e={}){const{wrapper:i}={...(0,o.R)(),...e.components};return i?(0,s.jsx)(i,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},28453:(e,i,n)=>{n.d(i,{R:()=>r,x:()=>c});var t=n(96540);const s={},o=t.createContext(s);function r(e){const i=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(i):{...i,...e}}),[i,e])}function c(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(o.Provider,{value:i},e.children)}}}]);