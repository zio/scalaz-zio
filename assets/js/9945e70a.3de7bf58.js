"use strict";(self.webpackChunkzio_site=self.webpackChunkzio_site||[]).push([[50381],{19380:(e,n,t)=>{t.d(n,{A:()=>r});const r=t.p+"assets/images/ZIOMetrics-Grafana-55da5b2aabcb63450c69108506e0f584.png"},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>a});var r=t(96540);const s={},i=r.createContext(s);function o(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(i.Provider,{value:n},e.children)}},71241:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>o,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"zio-metrics-connectors/metrics/prometheus-client","title":"Prometheus Client","description":"In a normal prometheus setup we will find prometheus agents which query configured endpoints","source":"@site/docs/zio-metrics-connectors/metrics/prometheus-client.md","sourceDirName":"zio-metrics-connectors/metrics","slug":"/zio-metrics-connectors/metrics/prometheus-client","permalink":"/zio-metrics-connectors/metrics/prometheus-client","draft":false,"unlisted":false,"editUrl":"https://github.com/zio/zio/edit/series/2.x/docs/zio-metrics-connectors/metrics/prometheus-client.md","tags":[],"version":"current","frontMatter":{"id":"prometheus-client","title":"Prometheus Client"},"sidebar":"ecosystem-sidebar","previous":{"title":"Datadog Client","permalink":"/zio-metrics-connectors/metrics/datadog-client"},"next":{"title":"Micrometer Connector","permalink":"/zio-metrics-connectors/metrics/micrometer-connector"}}');var s=t(74848),i=t(28453);const o={id:"prometheus-client",title:"Prometheus Client"},a=void 0,l={},c=[{value:"ZIO Metrics in Prometheus",id:"zio-metrics-in-prometheus",level:2},{value:"Counter",id:"counter",level:3},{value:"Gauge",id:"gauge",level:3},{value:"Histogram",id:"histogram",level:3},{value:"Summary",id:"summary",level:3},{value:"Set",id:"set",level:3},{value:"Serving Prometheus metrics",id:"serving-prometheus-metrics",level:2},{value:"Running the prometheus example",id:"running-the-prometheus-example",level:2},{value:"Simple Prometheus setup",id:"simple-prometheus-setup",level:2},{value:"Download and configure Prometheus",id:"download-and-configure-prometheus",level:3},{value:"Download and configure Grafana",id:"download-and-configure-grafana",level:3},{value:"Grafana dashboard",id:"grafana-dashboard",level:3}];function h(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["In a normal prometheus setup we will find prometheus agents which query configured endpoints\nat regular intervals. The endpoints are HTTP endpoints serving the current metric state in\nan encoding defined by ",(0,s.jsx)(n.a,{href:"https://prometheus.io/docs/instrumenting/exposition_formats/#text-based-format",children:"prometheus"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"ZIO Metrics provides the Prometheus encoding for the captured metrics out of the box. To avoid enforcing\na particular HTTP implementation, an instrumented application needs to expose the encoded format\nas an endpoint with the HTTP server of it\xb4s choice."}),"\n",(0,s.jsx)(n.h2,{id:"zio-metrics-in-prometheus",children:"ZIO Metrics in Prometheus"}),"\n",(0,s.jsx)(n.p,{children:"Most of the ZIO metrics have a direct representation in the Prometheus encoding."}),"\n",(0,s.jsx)(n.h3,{id:"counter",children:"Counter"}),"\n",(0,s.jsx)(n.p,{children:"A counter is represented as a prometheus counter."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"# TYPE countAll counter\n# HELP countAll \ncountAll 460.0 1623586224730\n"})}),"\n",(0,s.jsx)(n.h3,{id:"gauge",children:"Gauge"}),"\n",(0,s.jsx)(n.p,{children:"A gauge is represented as a prometheus gauge."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"# TYPE adjustGauge gauge\n# HELP adjustGauge \nadjustGauge -1.2485836762095701 1623586224730\n"})}),"\n",(0,s.jsx)(n.h3,{id:"histogram",children:"Histogram"}),"\n",(0,s.jsx)(n.p,{children:"A histogram is represented as a prometheus histogram."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'# TYPE myHistogram histogram\n# HELP myHistogram \nmyHistogram{le="0.0"} 0.0 1623586224730\nmyHistogram{le="10.0"} 8.0 1623586224730\nmyHistogram{le="20.0"} 18.0 1623586224730\nmyHistogram{le="30.0"} 30.0 1623586224730\nmyHistogram{le="40.0"} 44.0 1623586224730\nmyHistogram{le="50.0"} 51.0 1623586224730\nmyHistogram{le="60.0"} 59.0 1623586224730\nmyHistogram{le="70.0"} 65.0 1623586224730\nmyHistogram{le="80.0"} 76.0 1623586224730\nmyHistogram{le="90.0"} 88.0 1623586224730\nmyHistogram{le="100.0"} 95.0 1623586224730\nmyHistogram{le="+Inf"} 115.0 1623586224730\nmyHistogram_sum 6828.578655207023 1623586224730\nmyHistogram_count 115.0 1623586224730\n'})}),"\n",(0,s.jsx)(n.h3,{id:"summary",children:"Summary"}),"\n",(0,s.jsx)(n.p,{children:"A histogram is represented as a prometheus summary."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'# TYPE mySummary summary\n# HELP mySummary \nmySummary{quantile="0.1",error="0.03"} 147.0 1623589839194\nmySummary{quantile="0.5",error="0.03"} 286.0 1623589839194\nmySummary{quantile="0.9",error="0.03"} 470.0 1623589839194\nmySummary_sum 42582.0 1623589839194\nmySummary_count 139.0 1623589839194\n'})}),"\n",(0,s.jsx)(n.h3,{id:"set",children:"Set"}),"\n",(0,s.jsx)(n.p,{children:"A set is represented by a set of prometheus counters, distinguished from each other with an\nextra label as configured in the aspect."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'# TYPE mySet counter\n# HELP mySet \nmySet{token="myKey-17"} 7.0 1623589839194\nmySet{token="myKey-18"} 9.0 1623589839194\nmySet{token="myKey-19"} 12.0 1623589839194\nmySet{token="myKey-13"} 6.0 1623589839194\nmySet{token="myKey-14"} 4.0 1623589839194\nmySet{token="myKey-15"} 6.0 1623589839194\nmySet{token="myKey-16"} 5.0 1623589839194\nmySet{token="myKey-10"} 10.0 1623589839194\nmySet{token="myKey-11"} 1.0 1623589839194\nmySet{token="myKey-12"} 10.0 1623589839194\n'})}),"\n",(0,s.jsx)(n.h2,{id:"serving-prometheus-metrics",children:"Serving Prometheus metrics"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-scala",children:"import zio.http._\n\nimport zio._\nimport zio.console._\nimport zio.metrics.connectors.{prometheusLayer, publisherLayer}\n\nimport sample.InstrumentedSample\n\nval instrumentedSample = new InstrumentedSample() {}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["ZIO Metrics connector provides a prometheus client that can be used to produce the prometheus encoded metric state\nupon request. The state is encoded in the ",(0,s.jsx)(n.code,{children:"PrometheusPublisher"})," case class and the single attribute of\ntype ",(0,s.jsx)(n.code,{children:"Ref[String]"})," holds the prometheus encoded metric state."]}),"\n",(0,s.jsxs)(n.p,{children:["So, to retrieve the prometheus encoded state, the application can simply use ",(0,s.jsx)(n.code,{children:"PrometheusPublisher#get"})," method:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-scala",children:"val encodedContent: UIO[String] = publisher.get\n"})}),"\n",(0,s.jsxs)(n.p,{children:["In our example application we use ",(0,s.jsx)(n.a,{href:"https://github.com/zio/zio-http",children:"zio-http"})," to serve the metrics. Other application might choose another HTTP server framework if required."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-scala",children:'private val metricsConfig = ZLayer.succeed(MetricsConfig(5.seconds))\n\nprivate lazy val indexPage =\n  """<html>\n    |<title>Simple Server</title>\n    |<body>\n    |<p><a href="/prometheus/metrics">Prometheus Metrics</a></p>\n    |<p><a href="/insight/keys">Insight Metrics: Get all keys</a></p>\n    |</body\n    |</html>""".stripMargin\n\nprivate lazy val static =\n  Http.collect[Request] { case Method.GET -> Root => Response.html(Html.fromString(indexPage)) }\n\nprivate lazy val prometheusRouter =\n  Http\n    .collectZIO[Request] { case Method.GET -> Root / "prometheus" / "metrics" =>\n      ZIO.serviceWithZIO[PrometheusPublisher](_.get.map(Response.text))\n    }\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Now, using the HTTP server and the ",(0,s.jsx)(n.a,{href:"/zio-metrics-connectors/metrics/instrumentation-examples",children:"instrumentation examples"})," we can create an effect\nthat simply runs the sample effects with their instrumentation. And within a ",(0,s.jsx)(n.code,{children:"ZIO.App"})," we can override the run method,\nwhich is now simply the execute method with a Prometheus client provided in it\xb4s environment:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-scala",children:"  private val serverInstall =\n  Server.install(static ++ prometheusRouter)\n\nprivate lazy val runHttp = (serverInstall *> ZIO.never).forkDaemon\n\nprivate lazy val serverConfig = ZLayer.succeed(Server.Config.default.port(bindPort))\n\noverride def run: ZIO[Environment & ZIOAppArgs & Scope, Any, Any] = (for {\n  f <- runHttp\n  _ <- program\n  _ <- f.join\n} yield ())\n  .provide(\n    serverConfig,\n    Server.live,\n\n    // This is the general config for all backends\n    metricsConfig,\n\n    // The prometheus reporting layer\n    prometheus.publisherLayer,\n    prometheus.prometheusLayer,\n\n    // Enable the ZIO internal metrics and the default JVM metricsConfig\n    // Do NOT forget the .unit for the JVM metrics layer\n    Runtime.enableRuntimeMetrics,\n    DefaultJvmMetrics.live.unit,\n  )\n"})}),"\n",(0,s.jsx)(n.h2,{id:"running-the-prometheus-example",children:"Running the prometheus example"}),"\n",(0,s.jsx)(n.p,{children:"Any of the examples can be run from a command line within the project checkout directory with"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"sbt sampleApp/run\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Out of the choices, select the option corresponding to ",(0,s.jsx)(n.code,{children:"sample.SamplePrometheusStatsDApp"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["If everything works, we should be able to use a web browser to go to ",(0,s.jsx)(n.code,{children:"http://localhost:8080/metrics"})," and should see something like"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'# TYPE myCounter counter\n# HELP myCounter\nmyCounter{effect="count2"} 46.0 1608982756235\n# TYPE setGauge gauge\n# HELP setGauge\nsetGauge 8.66004641453435 1608982756235\n# TYPE changeGauge gauge\n# HELP changeGauge\nchangeGauge 90.7178906485008 1608982756235\n# TYPE myCounter counter\n# HELP myCounter\nmyCounter{effect="count1"} 92.0 1608982756235\n'})}),"\n",(0,s.jsx)(n.p,{children:"Once we see the metrics being served from our example, we can set up Prometheus and Grafana to create a simple dashboard displaying\nour metrics."}),"\n",(0,s.jsx)(n.h2,{id:"simple-prometheus-setup",children:"Simple Prometheus setup"}),"\n",(0,s.jsx)(n.p,{children:"The following steps have been tested on Ubuntu 18.04 running inside the Windows Subsystem for Linux.\nEssentially, you need to download the prometheus binaries for your environment and start the server\nwith our sample configuration located at"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"${PROJECT_HOME}/examples/prometheus/promcfg.yml\n"})}),"\n",(0,s.jsxs)(n.p,{children:["This will just configure a prometheus job that regular polls ",(0,s.jsx)(n.code,{children:"http://localhost:8080/metrics"})," for prometheus\nencoded metrics."]}),"\n",(0,s.jsx)(n.p,{children:"In addition, you need to download the Grafana binaries for your installation, start the Grafana server and configure\nprometheus as a single data source."}),"\n",(0,s.jsxs)(n.p,{children:["Finally, you can import our example dashboard at ",(0,s.jsx)(n.code,{children:"examples/prometheus/ZIOMetricsDashboard.json"})," and enjoy the results."]}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"These steps are not intended to replace the Prometheus or Grafana documentation. Please refer to their web sites\nfor guidelines towards a more sophisticated setup or an installation on different platforms."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"download-and-configure-prometheus",children:"Download and configure Prometheus"}),"\n",(0,s.jsxs)(n.p,{children:["In the steps below the project checkout directory will be referred to as ",(0,s.jsx)(n.code,{children:"$DIR"}),"."]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/prometheus/prometheus/releases/download/v2.23.0/prometheus-2.23.0.linux-amd64.tar.gz",children:"Download"})," prometheus"]}),"\n",(0,s.jsxs)(n.li,{children:["Extract the downloaded archive to a directory of your choice, this will be referred to as ",(0,s.jsx)(n.code,{children:"$PROMDIR"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Within ",(0,s.jsx)(n.code,{children:"$PROMDIR"})," execute","\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"./prometheus --config.file $DIR/examples/prometheus/promcfg.yml\n"})}),"\n","This will start the prometheus server which regularly polls the HTTP endpoint of the example above for its metrics."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"download-and-configure-grafana",children:"Download and configure Grafana"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://dl.grafana.com/oss/release/grafana-7.3.6.linux-amd64.tar.gz",children:"Download"})," grafana"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Extract the downloaded archive to a directory of your choice, this will be referred to as ",(0,s.jsx)(n.code,{children:"$GRAFANADIR"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Within ",(0,s.jsx)(n.code,{children:"$GRAFANADIR"})," execute"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"./bin/grafana-server\n"})}),"\n",(0,s.jsx)(n.p,{children:"This will start a Grafana server."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Now you should be able to login to Grafana at ",(0,s.jsx)(n.code,{children:"http://localhost:3000' with the default user "}),"admin",(0,s.jsx)(n.code,{children:"with the default  password"}),"admin`."]}),"\n",(0,s.jsx)(n.p,{children:"Upon the first login you will be asked to change the default password."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Within the Grafana menu on the left hand side you will find ",(0,s.jsx)(n.code,{children:"Manage Dashboards"})," within that page, select ",(0,s.jsx)(n.code,{children:"Import"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"You can now either install a dashboard from grafana.com or use a text field to paste JSON."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Paste the content of ",(0,s.jsx)(n.code,{children:"$DIR/examples/prometheus/ZIOMetricsDashboard.json"})," into the text field and select ",(0,s.jsx)(n.code,{children:"Load"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"This will import our dashboard example."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Now, under ",(0,s.jsx)(n.code,{children:"Manage Dashboards"})," the just imported ZIO dashboard should be visible."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Navigate to the dashboard."}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"grafana-dashboard",children:"Grafana dashboard"}),"\n",(0,s.jsx)(n.p,{children:"Here is a screenshot of the Grafana dashboard produced with the setup above."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"A simple Grafana Dashboard",src:t(19380).A+"",width:"2804",height:"1987"})})]})}function d(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}}}]);