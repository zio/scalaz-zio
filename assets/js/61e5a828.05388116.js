"use strict";(self.webpackChunkzio_site=self.webpackChunkzio_site||[]).push([[53311],{1996:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"reference/test/sharing-layers-between-multiple-files","title":"Sharing Layers Between Multiple Files","description":"In the previous example, we used the Spec#provideXYZShared methods to share layers between multiple specs in one file. In most cases, when the number of tests and specs grows, this is not a good idea. We want a way to share layers between multiple specs in different files.","source":"@site/docs/reference/test/sharing-layers-between-multiple-files.md","sourceDirName":"reference/test","slug":"/reference/test/sharing-layers-between-multiple-files","permalink":"/reference/test/sharing-layers-between-multiple-files","draft":false,"unlisted":false,"editUrl":"https://github.com/zio/zio/edit/series/2.x/docs/reference/test/sharing-layers-between-multiple-files.md","tags":[],"version":"current","frontMatter":{"id":"sharing-layers-between-multiple-files","title":"Sharing Layers Between Multiple Files"},"sidebar":"reference-sidebar","previous":{"title":"Sharing Layers within the Same File","permalink":"/reference/test/sharing-layers-within-the-same-file"},"next":{"title":"Spec","permalink":"/reference/test/spec"}}');var r=s(74848),i=s(28453);const a={id:"sharing-layers-between-multiple-files",title:"Sharing Layers Between Multiple Files"},o=void 0,c={},l=[];function d(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(t.p,{children:["In the previous example, we used the ",(0,r.jsx)(t.code,{children:"Spec#provideXYZShared"})," methods to share layers between multiple specs in one file. In most cases, when the number of tests and specs grows, this is not a good idea. We want a way to share layers between multiple specs in different files."]}),"\n",(0,r.jsxs)(t.p,{children:["So in such situations, we can't use the previous pattern here, because specs are in entirely different files, and we don't want the boilerplate of creating a ",(0,r.jsx)(t.em,{children:"master spec"})," that references the other specs. ZIO has a solution to this problem. We can define the resource we want to share as part of the ",(0,r.jsx)(t.code,{children:"bootstrap"})," layer of ",(0,r.jsx)(t.code,{children:"ZIOApp"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.code,{children:"bootstrap"})," layer is responsible for creating and managing any services that our ZIO tests need. Using ",(0,r.jsx)(t.code,{children:"boostrap"})," we can have one shared layer across multiple test specs."]}),"\n",(0,r.jsx)(t.admonition,{type:"note",children:(0,r.jsx)(t.p,{children:"When layers of the same type are defined at the class level within different test suites, they will be initialized separately for each test suite. This can lead to resource exhaustion especially with limited resources like database connections or connection pools. To avoid this, we need to ensure that such layers are defined centrally such as in the companion object to be shared properly across multiple test suites."})}),"\n",(0,r.jsxs)(t.p,{children:["Before we start, let's remember the ",(0,r.jsx)(t.code,{children:"Counter"})," service in the previous ",(0,r.jsx)(t.a,{href:"/reference/test/sharing-layers-within-the-same-file",children:"section"}),":"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-scala",children:'import zio._\n\ncase class Counter(value: Ref[Int]) {\n  def inc: UIO[Unit] = value.update(_ + 1)\n  def get: UIO[Int] = value.get\n}\n\nobject Counter {\n  val layer =\n    ZLayer.scoped(\n      ZIO.acquireRelease(\n        Ref.make(0).map(Counter(_)) <* ZIO.debug("Counter initialized!")\n      )(c => c.get.debug("Number of tests executed"))\n    )\n  def inc = ZIO.service[Counter].flatMap(_.inc)\n}\n'})}),"\n",(0,r.jsxs)(t.p,{children:["Now, let's assume we have two specs in different files, and we want to share the ",(0,r.jsx)(t.code,{children:"Counter"})," service between them. First, we need to create a base class that contains the shared bootstrap layer:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-scala",children:"import zio._\nimport zio.test._\n\nabstract class SharedCounterSpec extends ZIOSpec[Counter] {\n  override val bootstrap: ZLayer[Any, Nothing, Counter] = Counter.layer\n}\n"})}),"\n",(0,r.jsxs)(t.p,{children:["Now it's time to create the specs. Each spec is extending the ",(0,r.jsx)(t.code,{children:"SharedCounterSpec"})," class."]}),"\n",(0,r.jsx)(t.p,{children:"Spec1.scala:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-scala",children:'import zio._\nimport zio.test._\n\nobject Spec1 extends SharedCounterSpec {\n  override def spec =\n    test("test1") {\n      assertTrue(true)\n    } @@ TestAspect.after(Counter.inc)\n}\n'})}),"\n",(0,r.jsx)(t.p,{children:"Spec2.scala:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-scala",children:'import zio._\nimport zio.test._\n\nobject Spec2 extends SharedCounterSpec {\n  override def spec: Spec[Scope with Counter, Any] =\n    test("test2") {\n      assertTrue(true)\n    } @@ TestAspect.after(Counter.inc)\n}\n'})}),"\n",(0,r.jsxs)(t.p,{children:["Now, when we run all specs (",(0,r.jsx)(t.code,{children:"sbt testOnly org.example.*"}),"), we will see an output like this:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"Counter initialized!\n+ test1\n+ test2\nNumber of tests executed: 2\n"})}),"\n",(0,r.jsxs)(t.p,{children:["The ZIO test runner will execute all specs with the shared bootstrap layer. This means that the ",(0,r.jsx)(t.code,{children:"Counter"})," service will be created and managed only once, and will be shared between all specs."]})]})}function h(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},28453:(e,t,s)=>{s.d(t,{R:()=>a,x:()=>o});var n=s(96540);const r={},i=n.createContext(r);function a(e){const t=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),n.createElement(i.Provider,{value:t},e.children)}}}]);