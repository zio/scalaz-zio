"use strict";(self.webpackChunkzio_site=self.webpackChunkzio_site||[]).push([[69160],{26987:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>p,frontMatter:()=>l,metadata:()=>o,toc:()=>s});const o=JSON.parse('{"id":"reference/di/automatic-layer-construction","title":"Automatic Layer Construction","description":"ZIO also has an automatic layer construction facility, which takes care of building dependency graphs from the individual layers and building blocks. So instead of manually composing layers together to build the final layer, we can only provide individual layers to the ZIO application, and it will do the rest.","source":"@site/docs/reference/di/automatic-layer-construction.md","sourceDirName":"reference/di","slug":"/reference/di/automatic-layer-construction","permalink":"/reference/di/automatic-layer-construction","draft":false,"unlisted":false,"editUrl":"https://github.com/zio/zio/edit/series/2.x/docs/reference/di/automatic-layer-construction.md","tags":[],"version":"current","frontMatter":{"id":"automatic-layer-construction","title":"Automatic Layer Construction"},"sidebar":"reference-sidebar","previous":{"title":"Manual Layer Construction","permalink":"/reference/di/manual-layer-construction"},"next":{"title":"Dependency Propagation","permalink":"/reference/di/dependency-propagation"}}');var a=i(74848),r=i(28453);const l={id:"automatic-layer-construction",title:"Automatic Layer Construction"},t=void 0,c={},s=[{value:"Providing Individual Layers to a ZIO Application",id:"providing-individual-layers-to-a-zio-application",level:2},{value:"Automatically Assembling Layers",id:"automatically-assembling-layers",level:2},{value:"ZLayer Debugging",id:"zlayer-debugging",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,r.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"ZIO also has an automatic layer construction facility, which takes care of building dependency graphs from the individual layers and building blocks. So instead of manually composing layers together to build the final layer, we can only provide individual layers to the ZIO application, and it will do the rest."}),"\n",(0,a.jsxs)(n.p,{children:["The automatic layer construction takes place at the ",(0,a.jsx)(n.em,{children:"compile-time"}),", so if there is a problem in providing a layer, we will receive an error or warning message. So it helps us to diagnose the problem. Additionally, it has a way to print the dependency graph using built-in debug layers."]}),"\n",(0,a.jsx)(n.h2,{id:"providing-individual-layers-to-a-zio-application",children:"Providing Individual Layers to a ZIO Application"}),"\n",(0,a.jsxs)(n.p,{children:["When we provide individual layers using ",(0,a.jsx)(n.code,{children:"ZIO#provide"}),", ",(0,a.jsx)(n.code,{children:"ZIO#provideCustom"}),", or ",(0,a.jsx)(n.code,{children:"ZIO#provideSome"})," to a ZIO application, the compiler will create the dependency graph automatically from the provided layers:"]}),"\n",(0,a.jsx)(n.admonition,{type:"info",children:(0,a.jsxs)(n.p,{children:["We have a ",(0,a.jsx)(n.a,{href:"/reference/di/dependency-propagation",children:"separate section"})," that describes different methods for providing layers to the ZIO application."]})}),"\n",(0,a.jsxs)(n.p,{children:["Assume we have written the following services (",(0,a.jsx)(n.code,{children:"Cake"}),", ",(0,a.jsx)(n.code,{children:"Chocolate"}),", ",(0,a.jsx)(n.code,{children:"Flour"}),", and ",(0,a.jsx)(n.code,{children:"Spoon"}),"):"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:"import zio._\n\ntrait Cake\n\nobject Cake {\n  val live: ZLayer[Chocolate & Flour, Nothing, Cake] =\n    for {\n      _ <- ZLayer.environment[Chocolate & Flour]\n      cake <- ZLayer.succeed(new Cake {})\n    } yield cake\n}\n\ntrait Spoon\n\nobject Spoon {\n  val live: ULayer[Spoon] =\n    ZLayer.succeed(new Spoon {})\n}\n\ntrait Chocolate\n\nobject Chocolate {\n  val live: ZLayer[Spoon, Nothing, Chocolate] =\n    ZLayer.service[Spoon].project(_ => new Chocolate {})\n}\n\ntrait Flour\n\nobject Flour {\n  val live: ZLayer[Spoon, Nothing, Flour] =\n    ZLayer.service[Spoon].project(_ => new Flour {})\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"Cake"})," service has the following dependency graph:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"          Cake\n          /   \\\n   Chocolate   Flour\n       |         |\n     Spoon     Spoon\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Now we can write an application that uses the ",(0,a.jsx)(n.code,{children:"Cake"})," service as below:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:'import zio._\n\nimport java.io.IOException\n\nval myApp: ZIO[Cake, IOException, Unit] = for {\n  cake <- ZIO.service[Cake]\n  _    <- Console.printLine(s"Yay! I baked a cake with flour and chocolate: $cake")\n} yield ()\n'})}),"\n",(0,a.jsxs)(n.p,{children:["The type of ",(0,a.jsx)(n.code,{children:"myApp"})," indicates we should provide ",(0,a.jsx)(n.code,{children:"Cake"})," to this ZIO application to run it. Let's give it that and see what happens:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:"object MainApp extends ZIOAppDefault {\n  def run =\n    myApp.provide(Cake.live)\n}\n\n// error:\n// \n// \u2500\u2500\u2500\u2500 ZLAYER ERROR \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n// \n//  Please provide layers for the following 2 types:\n// \n//    Required by Cake.live\n//    1. Chocolate\n//    2. Flour\n//    \n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n"})}),"\n",(0,a.jsx)(n.p,{children:"Here are the errors that will be printed:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"\u2500\u2500\u2500\u2500 ZLAYER ERROR \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n Please provide layers for the following 2 types:\n\n   Required by Cake.live\n   1. Chocolate\n   2. Flour\n   \n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n"})}),"\n",(0,a.jsxs)(n.p,{children:["It says that we missed providing ",(0,a.jsx)(n.code,{children:"Chocolate"})," and ",(0,a.jsx)(n.code,{children:"Flour"})," layers. Now let's add these two missing layers:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:"import zio._\n\nobject MainApp extends ZIOAppDefault {\n  def run =\n    myApp.provide(\n      Cake.live,\n      Chocolate.live,\n      Flour.live\n    )\n}\n\n// error:\n// \n// \u2500\u2500\u2500\u2500 ZLAYER ERROR \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n// \n// Please provide a layer for the following type:\n// \n// Required by Flour.live\n// 1. Spoon\n// \n// Required by Chocolate.live\n// 1. Spoon\n// \n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Again, the compiler asks us to provide another dependency called ",(0,a.jsx)(n.code,{children:"Spoon"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"\u2500\u2500\u2500\u2500 ZLAYER ERROR \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nPlease provide a layer for the following type:\n\nRequired by Flour.live\n1. Spoon\n\nRequired by Chocolate.live\n1. Spoon\n\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n"})}),"\n",(0,a.jsx)(n.p,{children:"Finally, our application compiles without any errors:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:"import zio._\n\nobject MainApp extends ZIOAppDefault {\n  def run =\n    myApp.provide(\n      Cake.live,\n      Chocolate.live,\n      Flour.live,\n      Spoon.live  \n    )\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"Note that the order of dependencies doesn't matter. We can provide them in any order."}),"\n",(0,a.jsx)(n.p,{children:"Now, let's compare the automatic layer construction with the manual one:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:"import zio._\n\nobject MainApp extends ZIOAppDefault {\n\n  val layers: ULayer[Cake] =\n      (((Spoon.live >>> Chocolate.live) ++ (Spoon.live >>> Flour.live)) >>> Cake.live)\n\n  def run = myApp.provideLayer(layers)\n\n}\n"})}),"\n",(0,a.jsx)(n.h2,{id:"automatically-assembling-layers",children:"Automatically Assembling Layers"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"ZLayer.make[R]"})," \u2014 Using ",(0,a.jsx)(n.code,{children:"ZLayer.make[R]"}),", we can provide a type ",(0,a.jsx)(n.code,{children:"R"})," and then provide individual layers as arguments, it will automatically assemble these layers to create a layer of type ",(0,a.jsx)(n.code,{children:"R"}),"."]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["For example, we can create a ",(0,a.jsx)(n.code,{children:"Cake"})," layer as below:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:"import zio._\n\nval cakeLayer: ZLayer[Any, Nothing, Cake] =\n  ZLayer.make[Cake](\n    Cake.live,\n    Chocolate.live,\n    Flour.live,\n    Spoon.live\n  )\n"})}),"\n",(0,a.jsx)(n.p,{children:"We can also create a layer for intersections of services:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:"import zio._\n\nval chocolateAndFlourLayer: ZLayer[Any, Nothing, Chocolate & Flour] =\n  ZLayer.make[Chocolate & Flour](\n    Chocolate.live,\n    Flour.live,\n    Spoon.live\n  )\n"})}),"\n",(0,a.jsxs)(n.ol,{start:"2",children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"ZLayer.makeSome[R0, R]"})," \u2014 Automatically constructs a layer for the provided type ",(0,a.jsx)(n.code,{children:"R"}),", leaving a remainder ",(0,a.jsx)(n.code,{children:"R0"}),":"]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:"import zio._\n\nval cakeLayer: ZLayer[Spoon, Nothing, Cake] =\n  ZLayer.makeSome[Spoon, Cake](\n    Cake.live,\n    Chocolate.live,\n    Flour.live\n  )\n"})}),"\n",(0,a.jsx)(n.h2,{id:"zlayer-debugging",children:"ZLayer Debugging"}),"\n",(0,a.jsxs)(n.p,{children:["To debug ZLayer construction, we have two built-in layers, i.e., ",(0,a.jsx)(n.code,{children:"ZLayer.Debug.tree"})," and ",(0,a.jsx)(n.code,{children:"ZLayer.Debug.mermaid"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["Let's include the ",(0,a.jsx)(n.code,{children:"ZLayer.Debug.tree"})," layer into the layer construction:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:"import zio._\n\nobject MainApp extends ZIOAppDefault {\n  def run =\n    myApp.provide(\n      Cake.live,\n      Chocolate.live,\n      Flour.live,\n      Spoon.live,\n      ZLayer.Debug.tree\n    )\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"The following debug messages will be generated by the compiler:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"[info]   ZLayer Wiring Graph\n[info]\n[info] \u25c9 Cake.live\n[info] \u251c\u2500\u25d1 Chocolate.live\n[info] \u2502 \u2570\u2500\u25d1 Spoon.live\n[info] \u2570\u2500\u25d1 Flour.live\n[info]   \u2570\u2500\u25d1 Spoon.live\n[info] \n"})}),"\n",(0,a.jsxs)(n.p,{children:["If we use the ",(0,a.jsx)(n.code,{children:"ZLayer.Debug.mermaid"})," layer, it will generate the following debug messages:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"[info]   ZLayer Wiring Graph  \n[info] \n[info] \u25c9 Cake.live\n[info] \u251c\u2500\u25d1 Chocolate.live\n[info] \u2502 \u2570\u2500\u25d1 Spoon.live\n[info] \u2570\u2500\u25d1 Flour.live\n[info]   \u2570\u2500\u25d1 Spoon.live\n[info] \n[info] Mermaid Live Editor Link\n[info] https://mermaid-js.github.io/mermaid-live-editor/edit/#eyJjb2RlIjoiZ3JhcGhcbiAgICBDb25zb2xlLmxpdmVcbiAgICBDYWtlLmxpdmUgLS0+IENob2NvbGF0ZS5saXZlXG4gICAgQ2FrZS5saXZlIC0tPiBGbG91ci5saXZlXG4gICAgRmxvdXIubGl2ZSAtLT4gU3Bvb24ubGl2ZVxuICAgIFNwb29uLmxpdmVcbiAgICBDaG9jb2xhdGUubGl2ZSAtLT4gU3Bvb24ubGl2ZVxuICAgICIsIm1lcm1haWQiOiAie1xuICBcInRoZW1lXCI6IFwiZGVmYXVsdFwiXG59IiwgInVwZGF0ZUVkaXRvciI6IHRydWUsICJhdXRvU3luYyI6IHRydWUsICJ1cGRhdGVEaWFncmFtIjogdHJ1ZX0=\n"})})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>t});var o=i(96540);const a={},r=o.createContext(a);function l(e){const n=o.useContext(r);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:l(e.components),o.createElement(r.Provider,{value:n},e.children)}}}]);