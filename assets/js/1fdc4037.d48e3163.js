"use strict";(self.webpackChunkzio_site=self.webpackChunkzio_site||[]).push([[63063],{28453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>t});var s=i(96540);const a={},l=s.createContext(a);function o(e){const n=s.useContext(l);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),s.createElement(l.Provider,{value:n},e.children)}},95947:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>r,contentTitle:()=>t,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"guides/tutorials/enable-logging-in-a-zio-application","title":"Tutorial: How to Enable Logging in a ZIO Application","description":"Introduction","source":"@site/docs/guides/tutorials/enable-logging-in-a-zio-application.md","sourceDirName":"guides/tutorials","slug":"/guides/tutorials/enable-logging-in-a-zio-application","permalink":"/guides/tutorials/enable-logging-in-a-zio-application","draft":false,"unlisted":false,"editUrl":"https://github.com/zio/zio/edit/series/2.x/docs/guides/tutorials/enable-logging-in-a-zio-application.md","tags":[],"version":"current","frontMatter":{"id":"enable-logging-in-a-zio-application","title":"Tutorial: How to Enable Logging in a ZIO Application","sidebar_label":"Enable Logging in a ZIO Application"},"sidebar":"guides-sidebar","previous":{"title":"Encoding and Decoding JSON Data","permalink":"/guides/tutorials/encode-and-decode-json-data"},"next":{"title":"Create Custom Logger for a ZIO Application","permalink":"/guides/tutorials/create-custom-logger-for-a-zio-application"}}');var a=i(74848),l=i(28453);const o={id:"enable-logging-in-a-zio-application",title:"Tutorial: How to Enable Logging in a ZIO Application",sidebar_label:"Enable Logging in a ZIO Application"},t=void 0,r={},d=[{value:"Introduction",id:"introduction",level:2},{value:"Running The Examples",id:"running-the-examples",level:2},{value:"Default Logger",id:"default-logger",level:2},{value:"Supported Log Levels",id:"supported-log-levels",level:2},{value:"Overriding Log Levels",id:"overriding-log-levels",level:2},{value:"UserApp: Add Logging",id:"userapp-add-logging",level:2},{value:"Logging Spans",id:"logging-spans",level:2},{value:"Multiple Spans",id:"multiple-spans",level:2},{value:"UserApp: Logging Spans",id:"userapp-logging-spans",level:2},{value:"Annotating Logs",id:"annotating-logs",level:2},{value:"UserApp: Logging Correlation Ids",id:"userapp-logging-correlation-ids",level:2},{value:"Conclusion",id:"conclusion",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,a.jsx)(n.p,{children:"ZIO has built-in support for logging. This tutorial will show you how to enable logging for a ZIO application."}),"\n",(0,a.jsx)(n.h2,{id:"running-the-examples",children:"Running The Examples"}),"\n",(0,a.jsxs)(n.p,{children:["In ",(0,a.jsx)(n.a,{href:"/guides/quickstarts/restful-webservice",children:"this quickstart"}),", we developed a web service containing 4 different HTTP Applications, but we haven't enabled logging for them. In this tutorial, we are going to enable logging for the ",(0,a.jsx)(n.code,{children:"UserApp"})," we have developed in this quickstart."]}),"\n",(0,a.jsxs)(n.p,{children:["To access the code examples, you can clone the ",(0,a.jsx)(n.a,{href:"http://github.com/zio/zio-quickstarts",children:"ZIO Quickstarts"})," project:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"$ git clone https://github.com/zio/zio-quickstarts.git\n$ cd zio-quickstarts/zio-quickstart-restful-webservice-logging\n"})}),"\n",(0,a.jsx)(n.p,{children:"And finally, run the application using sbt:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"$ sbt run\n"})}),"\n",(0,a.jsx)(n.p,{children:"Alternatively, to enable hot-reloading and prevent port binding issues, you can use:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"sbt reStart\n"})}),"\n",(0,a.jsxs)(n.admonition,{type:"note",children:[(0,a.jsxs)(n.p,{children:['If you encounter a "port already in use" error, you can use ',(0,a.jsx)(n.code,{children:"sbt-revolver"})," to manage server restarts more effectively. The ",(0,a.jsx)(n.code,{children:"reStart"})," command will start your server and ",(0,a.jsx)(n.code,{children:"reStop"})," will properly stop it, releasing the port."]}),(0,a.jsxs)(n.p,{children:["To enable this feature, we have included ",(0,a.jsx)(n.code,{children:"sbt-revolver"})," in the project. For more details on this, refer to the ",(0,a.jsx)(n.a,{href:"https://zio.dev/zio-http/installation#hot-reload-changes-watch-mode",children:"ZIO HTTP documentation on hot-reloading"}),"."]})]}),"\n",(0,a.jsx)(n.h2,{id:"default-logger",children:"Default Logger"}),"\n",(0,a.jsxs)(n.p,{children:["ZIO has a default logger that prints any log messages that are equal, or above the ",(0,a.jsx)(n.code,{children:"Level.Info"})," level:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:'import zio._\n\nobject MainApp extends ZIOAppDefault {\n  def run = ZIO.log("Application started")\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"This will print the following message to the console:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'timestamp=2022-06-01T09:43:08.848398Z level=INFO thread=#zio-fiber-6 message="Application started" location=zio.examples.MainApp.run file=MainApp.scala line=4\n'})}),"\n",(0,a.jsxs)(n.p,{children:["If we want to include the ",(0,a.jsx)(n.code,{children:"Cause"})," in the log message, we can use the ",(0,a.jsx)(n.code,{children:"ZIO.logCause"})," which takes the message and also the cause:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",metastring:"modc:compile-only",children:'import zio._\n\nobject MainApp extends ZIOAppDefault {\n\n  def run =\n    ZIO\n      .dieMessage("Boom!")\n      .foldCauseZIO(\n        cause => ZIO.logErrorCause("application stopped working due to an unexpected error", cause),\n        _ => ZIO.unit\n      )\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"Here is the output which includes the cause:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'timestamp=2022-06-02T05:18:04.131876Z level=ERROR thread=#zio-fiber-6 message="application stopped working due to an unexpected error" cause="Exception in thread "zio-fiber-6" java.lang.RuntimeException: Boom!\nat zio.examples.MainApp.run(MainApp.scala:9)\nat zio.examples.MainApp.run(MainApp.scala:10)" location=zio.examples.MainApp.run file=MainApp.scala line=11\n'})}),"\n",(0,a.jsx)(n.h2,{id:"supported-log-levels",children:"Supported Log Levels"}),"\n",(0,a.jsxs)(n.p,{children:["To distinguish importance of log messages from each other, ZIO supports the following log levels. The default log level is ",(0,a.jsx)(n.code,{children:"Info"}),", so when we use the ",(0,a.jsx)(n.code,{children:"ZIO.log"})," or ",(0,a.jsx)(n.code,{children:"ZIO.logCause"})," methods, the log message will be logged at the ",(0,a.jsx)(n.code,{children:"Info"})," level. For other log levels, we can use any of the ",(0,a.jsx)(n.code,{children:"ZIO.log*"})," or ",(0,a.jsx)(n.code,{children:"ZIO.log*Cause"})," methods:"]}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"LogLevel"}),(0,a.jsx)(n.th,{children:"Value"}),(0,a.jsx)(n.th,{children:"Log Message"}),(0,a.jsx)(n.th,{children:"Log with Cause"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"All"}),(0,a.jsx)(n.td,{children:"Int.MinValue"}),(0,a.jsx)(n.td,{}),(0,a.jsx)(n.td,{})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Fatal"}),(0,a.jsx)(n.td,{children:"50000"}),(0,a.jsx)(n.td,{children:"ZIO.logFatal"}),(0,a.jsx)(n.td,{children:"ZIO.logFatalCause"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Error"}),(0,a.jsx)(n.td,{children:"40000"}),(0,a.jsx)(n.td,{children:"ZIO.logError"}),(0,a.jsx)(n.td,{children:"ZIO.logErrorCause"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Warning"}),(0,a.jsx)(n.td,{children:"30000"}),(0,a.jsx)(n.td,{children:"ZIO.logWarning"}),(0,a.jsx)(n.td,{children:"ZIO.logWarningCause"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Info"}),(0,a.jsx)(n.td,{children:"20000"}),(0,a.jsx)(n.td,{children:"ZIO.logInfo"}),(0,a.jsx)(n.td,{children:"ZIO.logInfoCause"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Debug"}),(0,a.jsx)(n.td,{children:"10000"}),(0,a.jsx)(n.td,{children:"ZIO.logDebug"}),(0,a.jsx)(n.td,{children:"ZIO.logDebugCause"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Trace"}),(0,a.jsx)(n.td,{children:"0"}),(0,a.jsx)(n.td,{children:"ZIO.logTrace"}),(0,a.jsx)(n.td,{children:"ZIO.logTraceCause"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"None"}),(0,a.jsx)(n.td,{children:"Int.MaxValue"}),(0,a.jsx)(n.td,{}),(0,a.jsx)(n.td,{})]})]})]}),"\n",(0,a.jsxs)(n.p,{children:["As we said earlier, the default logger prints log messages equal or above the ",(0,a.jsx)(n.code,{children:"Info"})," level. So, if we run the following code, only the ",(0,a.jsx)(n.code,{children:"Info"}),", ",(0,a.jsx)(n.code,{children:"Warning"}),", and ",(0,a.jsx)(n.code,{children:"Error"})," and the ",(0,a.jsx)(n.code,{children:"Fatal"})," log messages will be printed:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:'import zio._\n\nobject MainApp extends ZIOAppDefault {\n  def run =\n    for {\n      _ <- ZIO.logFatal("Fatal")\n      _ <- ZIO.logError("Error")\n      _ <- ZIO.logWarning("Warning")\n      _ <- ZIO.logInfo("Info")\n      _ <- ZIO.logDebug("Debug")\n      _ <- ZIO.logTrace("Trace")\n    } yield ()\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"The output will look like the following:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'timestamp=2022-06-01T10:16:26.623633Z level=FATAL thread=#zio-fiber-6 message="Fatal" location=zio.examples.MainApp.run file=MainApp.scala line=6\ntimestamp=2022-06-01T10:16:26.638771Z level=ERROR thread=#zio-fiber-6 message="Error" location=zio.examples.MainApp.run file=MainApp.scala line=7\ntimestamp=2022-06-01T10:16:26.640827Z level=WARN thread=#zio-fiber-6 message="Warning" location=zio.examples.MainApp.run file=MainApp.scala line=8\ntimestamp=2022-06-01T10:16:26.642260Z level=INFO thread=#zio-fiber-6 message="Info" location=zio.examples.MainApp.run file=MainApp.scala line=9\n'})}),"\n",(0,a.jsx)(n.h2,{id:"overriding-log-levels",children:"Overriding Log Levels"}),"\n",(0,a.jsxs)(n.p,{children:["As we mentioned, the default log level for ZIO.log and ZIO.logCause is ",(0,a.jsx)(n.code,{children:"Info"}),". We can use these two methods to log various part of our workflow, and then finally we can wrap the whole workflow with our desired log level:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:'import zio._\n\nZIO.logLevel(LogLevel.Debug) {\n  for {\n    _ <- ZIO.log("Workflow Started.")\n    _ <- ZIO.log("Running task 1.")\n    _ <- ZIO.log("Running task 2.")\n    _ <- ZIO.log("Workflow Completed.")\n  } yield ()\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"userapp-add-logging",children:"UserApp: Add Logging"}),"\n",(0,a.jsxs)(n.p,{children:["In this section, we are going to log all the HTTP requests coming to the ",(0,a.jsx)(n.code,{children:"UserApp"}),", and then in each step, when we are handling a request we will log the result, whether is successful or not."]}),"\n",(0,a.jsx)(n.p,{children:'We demonstrate this for the "POST /users" endpoint. This process is the same for all the other endpoints:'}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:'import zio._\nimport zio.json._\nimport zio.http._\n\nRoutes(\n  // POST /users -d \'{"name": "John", "age": 35}\'\n  Method.POST / "users" -> handler { (req: Request) =>\n    (for {\n      body <- req.body.asString\n      _ <- ZIO.logInfo(s"POST /users -d $body")\n      u = body.fromJson[User]\n      r <- u match {\n        case Left(e) =>\n          ZIO.logErrorCause(s"Failed to parse the input", Cause.fail(e))\n            .as(Response.text(e).status(Status.BadRequest))\n        case Right(u) =>\n          UserRepo.register(u)\n            .foldCauseZIO(\n              failure =>\n                ZIO.logErrorCause(s"Failed to register user", Cause.fail(failure))\n                  .as(Response.status(Status.InternalServerError)),\n              success =>\n                ZIO.logInfo(s"User registered: $success")\n                  .as(Response.text(success))\n            )\n      }\n    } yield r) @@ logSpan("register-user") @@ logAnnotateCorrelationId(req)\n  }\n)\n'})}),"\n",(0,a.jsx)(n.h2,{id:"logging-spans",children:"Logging Spans"}),"\n",(0,a.jsxs)(n.p,{children:["ZIO supports logging spans. A span is a logical unit of work that is composed of a start and end time. The start time is when the span is created and the end time is when the span is completed. The span is useful for measuring the time it takes to execute a piece of code. To create a new span, we can use the ",(0,a.jsx)(n.code,{children:"ZIO.logSpan"})," function as follows:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:'import zio._\n\nZIO.logSpan("span name") {\n  // do some work\n  // log inside the span\n  // do some more work\n  // another log inside the span\n}\n'})}),"\n",(0,a.jsxs)(n.p,{children:["For example, assume we have a function that takes the ",(0,a.jsx)(n.code,{children:"username"}),' and returns the profile picture of the user. We can wrap the whole function in a new span called "get-profile-picture" and log inside the span:']}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:'import zio._\n\ncase class User(id: String, name: String, profileImage: String)\n\ndef getProfilePicture(username: String) =\n  ZIO.logSpan("get-profile-picture") {\n    for {\n      _    <- ZIO.log(s"Getting information of $username from the UserService")\n      user <- ZIO.succeed(User("1", "john", "john.png"))\n      _    <- ZIO.log(s"Downloading profile image ${user.profileImage}")\n      img  <- ZIO.succeed(Array[Byte](1, 2, 3))\n      _    <- ZIO.log("Profile image downloaded")\n    } yield img\n  }\n'})}),"\n",(0,a.jsxs)(n.p,{children:["If we run this code with ",(0,a.jsx)(n.code,{children:'getProfilePicture("john")'}),", the output will look like the following:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'timestamp=2022-06-01T13:59:40.779263Z level=INFO thread=#zio-fiber-6 message="Getting information of john from the UserService" get-profile-picture=6ms location=zio.examples.MainApp.getProfilePicture file=MainApp.scala line=11\ntimestamp=2022-06-01T13:59:40.793804Z level=INFO thread=#zio-fiber-6 message="Downloading profile image john.png" get-profile-picture=20ms location=zio.examples.MainApp.getProfilePicture file=MainApp.scala line=13\ntimestamp=2022-06-01T13:59:40.795677Z level=INFO thread=#zio-fiber-6 message="Profile image downloaded" get-profile-picture=22ms location=zio.examples.MainApp.getProfilePicture file=MainApp.scala line=15\n'})}),"\n",(0,a.jsx)(n.p,{children:"Any logs inside the span region will be logged with the span name and the duration from the start of the span."}),"\n",(0,a.jsx)(n.h2,{id:"multiple-spans",children:"Multiple Spans"}),"\n",(0,a.jsx)(n.p,{children:"We can also create multiple spans and log inside them:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:'import zio._\n\nZIO.logSpan("span1") {\n  for {\n    _ <- ZIO.log("log inside span1")\n    _ <- ZIO.logSpan("span2") {\n      ZIO.log("log inside span1 and span2")\n    }\n    _ <- ZIO.log("log inside span1")\n  } yield ()\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"userapp-logging-spans",children:"UserApp: Logging Spans"}),"\n",(0,a.jsxs)(n.p,{children:["To measure the time taken to process the request at different points of the code, we can wrap any workflow with ",(0,a.jsx)(n.code,{children:"ZIO.logSpan"}),". In the ",(0,a.jsx)(n.code,{children:"UserApp"})," example, we wrote a workflow that handles the registration of a new user. We can wrap the workflow in a span and log inside the span:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:'import zio._\nimport zio.http._\n\nRoutes(\n  // POST /users -d \'{"name": "John", "age": 35}\'\n  Method.POST / "users" ->\n    handler(ZIO.logSpan("register-user") {\n      ??? // registration workflow\n    })\n)\n'})}),"\n",(0,a.jsxs)(n.p,{children:["As we need the same for all other endpoints, we introduced a new ZIO Aspect called ",(0,a.jsx)(n.code,{children:"LogAspect.logSpan"})," which can be applied to any ZIO workflow. Let's see how it is implemented and how it works:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:"import zio._\n\nobject LogAspect {\n  def logSpan(\n      label: String\n  ): ZIOAspect[Nothing, Any, Nothing, Any, Nothing, Any] =\n    new ZIOAspect[Nothing, Any, Nothing, Any, Nothing, Any] {\n      override def apply[R, E, A](zio: ZIO[R, E, A])(\n        implicit trace: Trace\n      ): ZIO[R, E, A] =\n        ZIO.logSpan(label)(zio)\n    }\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:["To apply this aspect to a ZIO workflow, we can use the ",(0,a.jsx)(n.code,{children:"@@"})," operator:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:"val workflow = ZIO.unit\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:'workflow @@ LogAspect.logSpan("register-user")\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Now, let's run the web service and post a request to the ",(0,a.jsx)(n.code,{children:"/users"})," endpoint and create a new user and see the logs:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'$ curl -i http://localhost:8080/users -d \'{"name": "John", "age": 42}\'\n'})}),"\n",(0,a.jsx)(n.p,{children:"And the logs:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'timestamp=2022-06-03T09:42:15.590135Z level=INFO thread=#zio-fiber-16 message="POST /users -d {"name": "John", "age": 42}" register-user=16ms location=dev.zio.quickstart.users.UserApp.apply.applyOrElse file=UserApp.scala line=22\ntimestamp=2022-06-03T09:42:15.748359Z level=INFO thread=#zio-fiber-16 message="User registered: 24c4ed63-ecc2-41fb-ac0e-5cbf22f187f6" register-user=174ms location=dev.zio.quickstart.users.UserApp.apply.applyOrElse file=UserApp.scala line=35\n'})}),"\n",(0,a.jsxs)(n.p,{children:["In the above logs, we can see that the ",(0,a.jsx)(n.code,{children:"register-user"})," span is created and the time taken to process the request is logged."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"register-user=16ms\nregister-user=174ms\n"})}),"\n",(0,a.jsx)(n.h2,{id:"annotating-logs",children:"Annotating Logs"}),"\n",(0,a.jsx)(n.p,{children:"The default log message is a string, containing a series of key-value pairs. It contains the following information:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"timestamp"}),": the time when the log is created"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"level"}),": the log level"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"thread"}),": the thread name (fiber name)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"message"}),": the log message"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"cause"}),": the cause of the log"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"location"}),": the location of the source code where the log is created (filename)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"line"}),": the line number of the source code where the log is created"]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["Other than these key-value pairs, we can also annotate the log message with other customized information using the ",(0,a.jsx)(n.code,{children:"ZIO.logAnnotate"})," function. This is especially useful when we are writing multiple services and we want to correlate logs between them using the ",(0,a.jsx)(n.code,{children:"CorrelationId"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"For example, when we are handling an HTTP request, we can annotate the log message with the user's id:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:'import zio._\n\nobject MainApp extends ZIOAppDefault {\n  // We use random delay to simulate interleaving of operations in real world\n  def randomDelay = Random.nextIntBounded(1000).flatMap(t => ZIO.sleep(t.millis))\n\n  def run =\n    ZIO.foreachParDiscard(Chunk("UserA", "UserB", "UserC")) { user =>\n      ZIO.logAnnotate("user-id", user) {\n        for {\n          _ <- randomDelay\n          _ <- ZIO.log("fetching user from database")\n          _ <- randomDelay\n          _ <- ZIO.log("downloading user\'s profile picture")\n        } yield ()\n      }\n    }\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"The output will look as follows:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'timestamp=2022-06-01T16:31:00.058151Z level=INFO thread=#zio-fiber-9 message="fetching user from database" location=zio.examples.MainApp.run file=MainApp.scala line=14 user-id=UserC\ntimestamp=2022-06-01T16:31:00.413569Z level=INFO thread=#zio-fiber-7 message="fetching user from database" location=zio.examples.MainApp.run file=MainApp.scala line=14 user-id=UserA\ntimestamp=2022-06-01T16:31:00.525170Z level=INFO thread=#zio-fiber-9 message="downloading user\'s profile picture" location=zio.examples.MainApp.run file=MainApp.scala line=16 user-id=UserC\ntimestamp=2022-06-01T16:31:00.807873Z level=INFO thread=#zio-fiber-8 message="fetching user from database" location=zio.examples.MainApp.run file=MainApp.scala line=14 user-id=UserB\ntimestamp=2022-06-01T16:31:00.830572Z level=INFO thread=#zio-fiber-7 message="downloading user\'s profile picture" location=zio.examples.MainApp.run file=MainApp.scala line=16 user-id=UserA\ntimestamp=2022-06-01T16:31:00.839411Z level=INFO thread=#zio-fiber-8 message="downloading user\'s profile picture" location=zio.examples.MainApp.run file=MainApp.scala line=16 user-id=UserB\n'})}),"\n",(0,a.jsxs)(n.p,{children:["As we can see, the ",(0,a.jsx)(n.code,{children:"user-id"})," with its value is annotated to each log message."]}),"\n",(0,a.jsx)(n.h2,{id:"userapp-logging-correlation-ids",children:"UserApp: Logging Correlation Ids"}),"\n",(0,a.jsxs)(n.p,{children:["To add a Correlation ID to the logs, we should first extract the ",(0,a.jsx)(n.code,{children:"X-Correlation-ID"})," header from the request and use it as the Correlation ID."]}),"\n",(0,a.jsxs)(n.p,{children:["As this is a common pattern along with all other endpoints, we created a new ZIO Aspect called ",(0,a.jsx)(n.code,{children:"LogAspect.logAnnotateCorrelationId"})," which can be applied to any ZIO workflow:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:'import zio._\nimport zio.http.Request\n\nobject LogAspect {\n  def logAnnotateCorrelationId(\n      req: Request\n  ): ZIOAspect[Nothing, Any, Nothing, Any, Nothing, Any] =\n    new ZIOAspect[Nothing, Any, Nothing, Any, Nothing, Any] {\n      override def apply[R, E, A](\n          zio: ZIO[R, E, A]\n      )(implicit trace: Trace): ZIO[R, E, A] =\n        correlationId(req).flatMap(id => ZIO.logAnnotate("correlation-id", id)(zio))\n\n      def correlationId(req: Request): UIO[String] =\n        ZIO\n          .succeed(req.headers.get("X-Correlation-ID"))\n          .flatMap(id => Random.nextUUID.map(uuid => id.getOrElse(uuid.toString)))\n    }\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"Now, we can apply this aspect to any ZIO workflow:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:"workflow @@ LogAspect.logAnnotateCorrelationId(req)\n"})}),"\n",(0,a.jsxs)(n.p,{children:["By applying this aspect to a ZIO workflow, all logs inside that workflow will be annotated with the ",(0,a.jsx)(n.code,{children:"correlation-id"})," annotation:"]}),"\n",(0,a.jsxs)(n.p,{children:["Let's run the web service and post a request to the ",(0,a.jsx)(n.code,{children:"/users"})," endpoint and create a new user and see the logs:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'$ curl -i -H "X-Correlation-ID: f798d2f2-abf2-46ff-b3f4-ae1888256706" \\\n      http://localhost:8080/users -d \'{"name": "John", "age": 42}\'\n'})}),"\n",(0,a.jsx)(n.p,{children:"Here are the logs:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-scala",children:'timestamp=2022-06-03T10:13:18.334468Z level=INFO thread=#zio-fiber-32 message="POST /users -d {"name": "John", "age": 42}" register-user=1ms location=dev.zio.quickstart.users.UserApp.apply.applyOrElse file=UserApp.scala line=22 correlation-id=f798d2f2-abf2-46ff-b3f4-ae1888256706\ntimestamp=2022-06-03T10:13:18.335034Z level=INFO thread=#zio-fiber-32 message="User registered: ec02143a-8030-4c70-a110-a497617c5c72" register-user=2ms location=dev.zio.quickstart.users.UserApp.apply.applyOrElse file=UserApp.scala line=35 correlation-id=f798d2f2-abf2-46ff-b3f4-ae1888256706\n'})}),"\n",(0,a.jsxs)(n.p,{children:["We can see that both log lines have the same ",(0,a.jsx)(n.code,{children:"correlation-id"})," annotation."]}),"\n",(0,a.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,a.jsx)(n.p,{children:"In this tutorial, we learned how to enable logging in a ZIO application and how to use the built-in logging facilities of ZIO without requiring any additional dependencies."}),"\n",(0,a.jsxs)(n.p,{children:["All the source code associated with this article is available on the ",(0,a.jsx)(n.a,{href:"http://github.com/zio/zio-quickstarts",children:"ZIO Quickstart"})," on Github."]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}}}]);