"use strict";(self.webpackChunkzio_site=self.webpackChunkzio_site||[]).push([[76574],{37115:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>a,contentTitle:()=>l,default:()=>m,frontMatter:()=>r,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"zio-memberlist/index","title":"Introduction to ZIO Memberlist","description":"ZIO-memberlist let you form cluster of multiply machines and by using gossip protocol which sends periodically messages between nodes maintain cluster and detects failining nodes.","source":"@site/docs/zio-memberlist/index.md","sourceDirName":"zio-memberlist","slug":"/zio-memberlist/","permalink":"/zio-memberlist/","draft":false,"unlisted":false,"editUrl":"https://github.com/zio/zio/edit/series/2.x/docs/zio-memberlist/index.md","tags":[],"version":"current","frontMatter":{"id":"index","title":"Introduction to ZIO Memberlist","sidebar_label":"ZIO Memberlist"},"sidebar":"ecosystem-sidebar","previous":{"title":"Testing","permalink":"/zio-logging/testing"},"next":{"title":"ZIO Meta","permalink":"/zio-meta/"}}');var t=n(74848),o=n(28453);const r={id:"index",title:"Introduction to ZIO Memberlist",sidebar_label:"ZIO Memberlist"},l=void 0,a={},c=[{value:"Installation",id:"installation",level:2},{value:"First Cluster",id:"first-cluster",level:2},{value:"Seeds nodes",id:"seeds-nodes",level:3},{value:"Static list of nodes",id:"static-list-of-nodes",level:4},{value:"Kubernetes service DNS",id:"kubernetes-service-dns",level:4},{value:"Define messages",id:"define-messages",level:2},{value:"Start Cluster",id:"start-cluster",level:2}];function d(e){const s={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.p,{children:"ZIO-memberlist let you form cluster of multiply machines and by using gossip protocol which sends periodically messages between nodes maintain cluster and detects failining nodes."}),"\n",(0,t.jsx)(s.p,{children:"Target for this library are users that builds distributed systems from the groud up. It could potentially be used to build next generation analytics platform, distributed caching solution or monitoring solutions to name a few."}),"\n",(0,t.jsxs)(s.p,{children:["Name of the project come from name of Hashicorp project ",(0,t.jsx)(s.a,{href:"https://github.com/hashicorp/memberlist",children:"memberlist"}),"."]}),"\n",(0,t.jsx)(s.h2,{id:"installation",children:"Installation"}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"ZIO-memberlist"})," is available via maven repo so import in ",(0,t.jsx)(s.code,{children:"build.sbt"})," is sufficient:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-scala",children:'resolvers += Resolver.sonatypeRepo("public")\n\nlibraryDependencies += "dev.zio" %% "zio-memberlist" % "0.0.0+40-a85dc5a1+20221121-1416-SNAPSHOT" \n'})}),"\n",(0,t.jsx)(s.h2,{id:"first-cluster",children:"First Cluster"}),"\n",(0,t.jsx)(s.h3,{id:"seeds-nodes",children:"Seeds nodes"}),"\n",(0,t.jsxs)(s.p,{children:["In most if not all of membership protocols we have a concept of seeds nodes. It is list of addresses to cluster nodes that new nodes will use to join a cluster. This list could be static list of IP addresses or it could be dns name that is dynamically updated when members join and leave. In ",(0,t.jsx)(s.code,{children:"ZIO-memberslist"})," we represent this via ",(0,t.jsx)(s.a,{href:"https://github.com/zio/zio-memberlist/blob/master/memberlist/src/main/scala/zio/memberlist/discovery/Discovery.scala",children:(0,t.jsx)(s.code,{children:"zio.memberlist.discovery.Discovery.Service"})}),".\nWe provide two implementations that should allow you to start cluster."]}),"\n",(0,t.jsx)(s.h4,{id:"static-list-of-nodes",children:"Static list of nodes"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-scala",children:'import zio.nio.core.SocketAddress._\n\nval seeds = Discovery.staticList(\n              Set(\n                inetSocketAddress("0.0.0.0", 5555), \n                inetSocketAddress("0.0.0.0", 5556)\n              )\n            )\n'})}),"\n",(0,t.jsx)(s.h4,{id:"kubernetes-service-dns",children:"Kubernetes service DNS"}),"\n",(0,t.jsx)(s.p,{children:"To make this work you need to create headless service in k8 to represent cluster. Below example of service configuration"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{children:"apiVersion: v1\nkind: Service\nmetadata:\n  name: zio-memberlist-srv\nspec:\n  clusterIP: None\n  publishNotReadyAddresses=True\n  ports:\n    - port: 5555\n      targetPort: swim\n      protocol: UDP\n      name: swim\n  selector:\n    app: zio-memberlist-node\n\n"})}),"\n",(0,t.jsx)(s.p,{children:"and code"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-scala",children:'import zio.memberslist.discovery.Discovery\nimport zio.duration._\nimport zio.nio.core.InetAddress\n\nval seeds = Discovery.k8Dns(\n              InetAddress.byName(\n                "name-of-namespace.zio-memberlist-srv", \n                10.seconds, \n                5555\n              )\n            )\n'})}),"\n",(0,t.jsx)(s.h2,{id:"define-messages",children:"Define messages"}),"\n",(0,t.jsx)(s.p,{children:"ZIO-memberlist allow you to send messages to other nodes in the cluster. However there is important limitation. Since ZIO-memberlist uses UDP for comunication your messages need to respect MTU."}),"\n",(0,t.jsx)(s.p,{children:"Here is example of messages that we could use to run Chaos experiment on the cluster"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-scala",children:"import upickle.default._\nimport zio.memberlist._\n\nsealed trait ChaosMonkey\n\nobject ChaosMonkey {\n  final case object SimulateCpuSpike extends ChaosMonkey\n\n  implicit val cpuSpikeCodec: ByteCodec[SimulateCpuSpike.type] =\n    ByaateCodec.fromReadWriter(macroRW[SimulateCpuSpike.type])\n\n  implicit val codec: ByteCodec[ChaosMonkey] =\n    ByteCodec.tagged[ChaosMonkey][\n      SimulateCpuSpike.type\n    ]\n}\n"})}),"\n",(0,t.jsxs)(s.p,{children:["As you see apart of messages we need to provide ",(0,t.jsx)(s.code,{children:"ByteCodec"})," instances that will be used to decode and encode your messages."]}),"\n",(0,t.jsx)(s.h2,{id:"start-cluster",children:"Start Cluster"}),"\n",(0,t.jsx)(s.p,{children:"We need to put this all together. Let start with dependencies."}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-scala",children:"val config      = SwimConfig.fromEnv.orDie\nval logging     = Logging.console((_, msg) => msg)\nval dependencie = (ZLayer.requires[Clock] ++ logging ++ config) >+> seeds >+>  Memberlist.live[ChaosMonkey]\n"})}),"\n",(0,t.jsx)(s.p,{children:"And program."}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-scala",children:'val program = receive[ChaosMonkey]\n      .foreach {\n        case (sender, message) =>\n          log.info(s"receive message: $message from: $sender") *>\n            ZIO.whenCase(message) {\n              case SimulateCpuSpike => log.info("simulating cpu spike")\n            }\n      }\n      .as(ExitCode.succeed)\n'})})]})}function m(e={}){const{wrapper:s}={...(0,o.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},28453:(e,s,n)=>{n.d(s,{R:()=>r,x:()=>l});var i=n(96540);const t={},o=i.createContext(t);function r(e){const s=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function l(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),i.createElement(o.Provider,{value:s},e.children)}}}]);