"use strict";(self.webpackChunkzio_site=self.webpackChunkzio_site||[]).push([[27109],{28453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>s});var o=i(96540);const r={},t=o.createContext(r);function a(e){const n=o.useContext(t);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),o.createElement(t.Provider,{value:n},e.children)}},43239:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>g,frontMatter:()=>a,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"zio-http/guides/integration-with-zio-config","title":"How to Integrate with ZIO Config","description":"When building HTTP applications, it is common to have configuration settings that need to be loaded from various sources such as environment variables, system properties, or configuration files. It is essential especially when deploying applications to different environments like development, testing, and production, or we want to have a cloud-native application that can be configured dynamically.","source":"@site/docs/zio-http/guides/integrate-with-zio-config.md","sourceDirName":"zio-http/guides","slug":"/zio-http/guides/integration-with-zio-config","permalink":"/zio-http/guides/integration-with-zio-config","draft":false,"unlisted":false,"editUrl":"https://github.com/zio/zio/edit/series/2.x/docs/zio-http/guides/integrate-with-zio-config.md","tags":[],"version":"current","frontMatter":{"id":"integration-with-zio-config","title":"How to Integrate with ZIO Config","sidebar_label":"Integration with ZIO Config"},"sidebar":"ecosystem-sidebar","previous":{"title":"ZIO HTTP","permalink":"/zio-http/"},"next":{"title":"Testing HTTP Applications","permalink":"/zio-http/guides/testing-http-apps"}}');var r=i(74848),t=i(28453);const a={id:"integration-with-zio-config",title:"How to Integrate with ZIO Config",sidebar_label:"Integration with ZIO Config"},s=void 0,l={},c=[{value:"ZIO Config Overview",id:"zio-config-overview",level:2},{value:"Loading Configuration Settings from a File",id:"loading-configuration-settings-from-a-file",level:2},{value:"Client and Server Configuration",id:"client-and-server-configuration",level:2},{value:"Predefined Configuration Schemas",id:"predefined-configuration-schemas",level:3},{value:"Loading Configuration Settings from Environment Variables",id:"loading-configuration-settings-from-environment-variables",level:2},{value:"Loading Configuration Settings from an HOCON File",id:"loading-configuration-settings-from-an-hocon-file",level:3},{value:"Customized Layers",id:"customized-layers",level:3},{value:"Summary",id:"summary",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"When building HTTP applications, it is common to have configuration settings that need to be loaded from various sources such as environment variables, system properties, or configuration files. It is essential especially when deploying applications to different environments like development, testing, and production, or we want to have a cloud-native application that can be configured dynamically."}),"\n",(0,r.jsxs)(n.p,{children:["ZIO HTTP provides seamless integration with ",(0,r.jsx)(n.a,{href:"https://zio.dev/zio-config/",children:"ZIO Config"}),", a powerful configuration library for ZIO, to manage configurations in your HTTP applications."]}),"\n",(0,r.jsx)(n.p,{children:"In this guide, we will learn how to integrate ZIO HTTP with ZIO Config to load configuration settings for our HTTP applications."}),"\n",(0,r.jsx)(n.h2,{id:"zio-config-overview",children:"ZIO Config Overview"}),"\n",(0,r.jsx)(n.p,{children:"The ZIO core library has a built-in configuration system that allows us to define a type-safe configuration schema, load configurations from various sources, validate configurations, and access configuration settings in a functional way."}),"\n",(0,r.jsxs)(n.p,{children:["We can define a configuration schema for any custom data type. For example, if we have a ",(0,r.jsx)(n.code,{children:"DatabaseConfig"})," case class as follows:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-scala",children:"case class DatabaseConfig(\n  url: String,\n  username: String,\n  password: String,\n  poolSize: Int,\n)\n"})}),"\n",(0,r.jsxs)(n.p,{children:["We can derive a configuration schema for ",(0,r.jsx)(n.code,{children:"DatabaseConfig"})," using ZIO Config as follows:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-scala",children:'import zio._\nimport zio.config._\nimport zio.config.magnolia._\n\nobject DatabaseConfig {\n  val config: Config[DatabaseConfig] =\n    DeriveConfig.deriveConfig[DatabaseConfig]\n      .mapKey(toSnakeCase)\n      .nested("database")\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Now, we can load the configuration settings for ",(0,r.jsx)(n.code,{children:"DatabaseConfig"})," by calling ",(0,r.jsx)(n.code,{children:"ZIO.config(DatabaseConfig.config)"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-scala",children:'import zio._\n\nobject MainApp extends ZIOAppDefault {\n  def run = {\n    for {\n      config <- ZIO.config(DatabaseConfig.config)\n      _      <- ZIO.debug("Just started right now!")\n      _      <- ZIO.debug(s"Connecting to the database: ${config.url}")\n    } yield () \n  }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"By default, ZIO will load the configs from environment variables, so we need to set the following environment variables:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'export DATABASE_URL="jdbc:postgresql://localhost:5432/mydb"\nexport DATABASE_USERNAME="admin"\nexport DATABASE_PASSWORD="password"\nexport DATABASE_POOL_SIZE=10\n'})}),"\n",(0,r.jsx)(n.h2,{id:"loading-configuration-settings-from-a-file",children:"Loading Configuration Settings from a File"}),"\n",(0,r.jsxs)(n.p,{children:["As we mentioned earlier, by default, ZIO loads configurations from environment variables. However, we can change the ",(0,r.jsx)(n.code,{children:"ConfigProvider"})," to load configurations from other sources such as system properties, console, and system properties. All of these are built-in providers in the ZIO core library."]}),"\n",(0,r.jsxs)(n.p,{children:["ZIO Config also provides more advanced ",(0,r.jsx)(n.code,{children:"ConfigProvider"}),"s such as HOCON, JSON, YAML, and XML. Based on the configuration format, we need to add one of the following dependencies to our project:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-scala",children:'libraryDependencies += "dev.zio" %% "zio-config-typesafe" % "4.0.2" // HOCON\nlibraryDependencies += "dev.zio" %% "zio-config-yaml"     % "4.0.2" // YAML and JSON\nlibraryDependencies += "dev.zio" %% "zio-config-xml"      % "4.0.2" // XML\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Assuming we have an ",(0,r.jsx)(n.code,{children:"application.conf"})," file inside the ",(0,r.jsx)(n.code,{children:"resources"})," directory with the following content:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hocon",children:'database {\n  url: "jdbc:mysql://localhost:3306/mydatabase"\n  url: ${?DATABASE_URL} \n  username: "user"\n  username: ${?DATABASE_USERNAME} \n  password: "password"\n  password: ${?DATABASE_PASSWORD} \n  pool_size: 20\n  pool_size: ${?DATABASE_POOL_SIZE} \n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Then, we can load it using the ",(0,r.jsx)(n.code,{children:"ConfigProvider.fromResourcePath"})," method:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-scala",children:'import zio._\nimport zio.http._\nimport zio.config.typesafe._\n\nobject MainApp extends ZIOAppDefault {\n  override val bootstrap: ZLayer[ZIOAppArgs, Any, Any] =\n    Runtime.setConfigProvider(ConfigProvider.fromResourcePath())\n\n  def run = \n    for {\n      config <- ZIO.config(DatabaseConfig.config)\n      _      <- ZIO.debug("Just started right now!")\n      _      <- ZIO.debug(s"Connecting to the database: ${config.url}")\n    } yield () \n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"client-and-server-configuration",children:"Client and Server Configuration"}),"\n",(0,r.jsxs)(n.p,{children:["Both ",(0,r.jsx)(n.code,{children:"Client"})," and ",(0,r.jsx)(n.code,{children:"Server"})," have the ",(0,r.jsx)(n.code,{children:"default"})," layer that requires no configuration and provides an instance of ",(0,r.jsx)(n.code,{children:"Client"})," and ",(0,r.jsx)(n.code,{children:"Server"})," with default settings:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-scala",children:"object Client {\n  val default: ZLayer[Any, Throwable, Client] = ???\n}\n\nobject Server {\n  val default: ZLayer[Any, Throwable, Server] = ???\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["In some cases, we need to customize the client or server settings such as timeouts, host, port, and other parameters. To do that, ZIO HTTP provides ",(0,r.jsx)(n.code,{children:"live"})," and ",(0,r.jsx)(n.code,{children:"customized"})," layers that require additional configuration settings:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-scala",children:"object Client {\n  case class Config(\n    // configuration settings for client\n  )\n  \n  val live      : ZLayer[Client.Config with NettyConfig with DnsResolver, Throwable, Client]  = ??? \n  def customized: ZLayer[Client.Config with ClientDriver with DnsResolver, Throwable, Client] = ???\n}\n\nobject Server {\n  case class Config(\n    // configuration settings for server \n  )\n  \n  val live      : ZLayer[Server.Config, Throwable, Server]               = ???\n  val customized: ZLayer[Server.Config & NettyConfig, Throwable, Server] = ???\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["So, to have a customized client or server, we need to provide configuration layers to satisfy the required dependencies. For example, to create a ",(0,r.jsx)(n.code,{children:"live"})," server, we need to provide a ",(0,r.jsx)(n.code,{children:"ZLayer"})," that produces a ",(0,r.jsx)(n.code,{children:"Server.Config"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"For a practical example, see the following code which enables the response compression in the server:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-scala",metastring:'title="zio-http-example/src/main/scala/example/ServerResponseCompression.scala" ',children:'package example\n\nimport zio._\n\nimport zio.http._\n\nobject ServerResponseCompression extends ZIOAppDefault {\n  val routes = Routes(\n    Method.GET / "hello" -> handler(Response.text("Hello, World!")),\n  ).sandbox\n\n  val config = ZLayer.succeed(\n    Server.Config.default.copy(\n      responseCompression = Some(Server.Config.ResponseCompressionConfig.default),\n    ),\n  )\n\n  def run = Server.serve(routes).provide(Server.live, config)\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["In the above example, we updated the default server configuration to enable the response compression. Finally, we provided the ",(0,r.jsx)(n.code,{children:"Server.live"})," and our customized config layer to the ",(0,r.jsx)(n.code,{children:"Server.serve"})," method."]}),"\n",(0,r.jsx)(n.h3,{id:"predefined-configuration-schemas",children:"Predefined Configuration Schemas"}),"\n",(0,r.jsxs)(n.p,{children:["Until now, we changed the server configuration programmatically inside the code. But what if we want to load the client or server configuration from a file, e.g. ",(0,r.jsx)(n.code,{children:"application.conf"}),"? We need to have a configuration schema for the client and server settings, i.e. ",(0,r.jsx)(n.code,{children:"zio.Config[Client.Config]"})," and ",(0,r.jsx)(n.code,{children:"zio.Config[Server.Config]"}),". Fortunately, ZIO HTTP provides these configuration schemas by default."]}),"\n",(0,r.jsxs)(n.p,{children:["Before going further, let's take a look at the ",(0,r.jsx)(n.code,{children:"Server.Config"})," and ",(0,r.jsx)(n.code,{children:"Client.Config"})," and see how are they defined in ZIO HTTP:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-scala",children:"object Client {\n  case class Config(\n    // configuration settings for client\n  )\n  object Config {\n    // Configuration Schema for Cleint.Config\n    val config: zio.Config[Client.Config] = ???\n\n    // default configuration for Client.Config\n    lazy val default: Client.Config = ???\n  }\n}\n\nobject Server {\n  case class Config(\n    // configuration settings for server\n  )\n  object Config {\n    // configuration schema for Server.Config\n    val config: zio.Config[Server.Config] = ???\n\n    // default configuration for Server.Config\n    lazy val default: Server.Config = ???\n  }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"Server"})," and ",(0,r.jsx)(n.code,{children:"Client"})," modules have predefined config schema, i.e. ",(0,r.jsx)(n.code,{children:"Server.Config.config"})," and ",(0,r.jsx)(n.code,{children:"Client.Config.config"}),", that can be used to load the server/client configuration from the environment, system properties, or any other configuration sources."]}),"\n",(0,r.jsx)(n.h2,{id:"loading-configuration-settings-from-environment-variables",children:"Loading Configuration Settings from Environment Variables"}),"\n",(0,r.jsxs)(n.p,{children:["As the ZIO HTTP provided these configuration schemas by default, we can easily use them to load the configuration settings from the considered sources using the corresponding ",(0,r.jsx)(n.code,{children:"ConfigProvider"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-scala",children:'import zio._\nimport zio.http._\n\nobject MainApp extends ZIOAppDefault {\n  def run = {\n    Server\n      .install(\n        Routes(\n          Method.GET / "hello" -> handler(Response.text("Hello, world!")),\n        ),\n      )\n      .flatMap(port => ZIO.debug(s"Sever started on http://localhost:$port") *> ZIO.never)\n      .provide(\n        Server.live,\n        ZLayer.fromZIO(\n          ZIO.config(Server.Config.config.mapKey(_.replace(\'-\', \'_\'))),\n        ),\n      )\n  }\n}\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"export BINDING_HOST=localhost\nexport BINDING_PORT=8081\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsxs)(n.p,{children:["In the above example, we used the ",(0,r.jsx)(n.code,{children:"mapKey"})," method to replace the ",(0,r.jsx)(n.code,{children:"-"})," character with ",(0,r.jsx)(n.code,{children:"_"})," in the configuration keys. This is because the environment variables do not allow the ",(0,r.jsx)(n.code,{children:"-"})," character in the key names."]})}),"\n",(0,r.jsx)(n.h3,{id:"loading-configuration-settings-from-an-hocon-file",children:"Loading Configuration Settings from an HOCON File"}),"\n",(0,r.jsxs)(n.p,{children:["By changing the ",(0,r.jsx)(n.code,{children:"ConfigProvider"})," to ",(0,r.jsx)(n.code,{children:"ConfigProvider.fromResourcePath()"}),", we can load the server configuration from the ",(0,r.jsx)(n.code,{children:"application.conf"})," file:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hocon",children:"zio.http.server {\n  binding_port: 8083\n  binding_host: localhot\n}\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-scala",metastring:'title="zio-http-example/src/main/scala/example/config/LoadServerConfigFromHoconFile.scala" ',children:'package example.config\n\nimport zio._\n\nimport zio.config._\nimport zio.config.typesafe._\n\nimport zio.http._\n\nobject LoadServerConfigFromHoconFile extends ZIOAppDefault {\n  override val bootstrap: ZLayer[ZIOAppArgs, Any, Any] =\n    Runtime.setConfigProvider(ConfigProvider.fromResourcePath())\n\n  def run = {\n    Server\n      .install(\n        Routes(\n          Method.GET / "hello" -> handler(Response.text("Hello, world!")),\n        ),\n      )\n      .flatMap(port => ZIO.debug(s"Sever started on http://localhost:$port") *> ZIO.never)\n      .provide(\n        Server.live,\n        ZLayer.fromZIO(\n          ZIO.config(Server.Config.config.nested("zio.http.server").mapKey(_.replace(\'-\', \'_\'))),\n        ),\n      )\n  }\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Instead of providing two layers (",(0,r.jsx)(n.code,{children:"Server.live"})," and ",(0,r.jsx)(n.code,{children:"ZLayer.fromZIO(ZIO.config(Server.Config.config))"}),") to the ",(0,r.jsx)(n.code,{children:"Server.serve"})," method, we can combine them into a single layer using the ",(0,r.jsx)(n.code,{children:"Server.configured"})," layer:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-scala",metastring:'title="zio-http-example/src/main/scala/example/config/HoconWithConfiguredLayerExample.scala" ',children:'package example.config\n\nimport zio._\n\nimport zio.config.typesafe._\n\nimport zio.http._\n\nobject HoconWithConfiguredLayerExample extends ZIOAppDefault {\n  override val bootstrap: ZLayer[ZIOAppArgs, Any, Any] =\n    Runtime.setConfigProvider(ConfigProvider.fromResourcePath())\n\n  def run = {\n    Server\n      .install(\n        Routes(\n          Method.GET / "hello" -> handler(Response.text("Hello, world!")),\n        ),\n      )\n      .flatMap(port => ZIO.debug(s"Sever started on http://localhost:$port") *> ZIO.never)\n      .provide(Server.configured())\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"customized-layers",children:"Customized Layers"}),"\n",(0,r.jsxs)(n.p,{children:["If we need to have more control, the ",(0,r.jsx)(n.code,{children:"Server"})," and ",(0,r.jsx)(n.code,{children:"Client"})," companion objects have also ",(0,r.jsx)(n.code,{children:"customized"})," layers that require additional configuration settings to customize the underlying settings for the server and client:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Server.customized"})," is a layer that requires a ",(0,r.jsx)(n.code,{children:"Server.Config"})," and ",(0,r.jsx)(n.code,{children:"NettyConfig"})," and returns a ",(0,r.jsx)(n.code,{children:"Server"})," layer."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"Client.customized"})," is a layer that requires a ",(0,r.jsx)(n.code,{children:"Client.Config"}),", ",(0,r.jsx)(n.code,{children:"NettyConfig"}),", and ",(0,r.jsx)(n.code,{children:"DnsResolver"})," and returns a ",(0,r.jsx)(n.code,{children:"Client"})," layer."]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-scala",children:"import zio._\nimport zio.http._\nimport zio.http.netty._\n"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-scala",children:"object Clinet {\n  case class Config(\n    // configuration settings for client\n  )\n  \n  val customized: ZLayer[Config with ClientDriver with DnsResolver, Throwable, Client] = ???\n}\n\nobject Server {\n  case class Config(\n    // configuration settings for server \n  )\n  \n  val customized: ZLayer[Config & NettyConfig, Throwable, Server] = ???\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,r.jsx)(n.p,{children:"In this guide, we learned how to integrate ZIO HTTP with ZIO Config to load configuration settings for our HTTP applications. We also learned how to load configuration settings from environment variables, system properties, and configuration files, such as HOCON and YAML using ZIO Config's configuration providers."})]})}function g(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);